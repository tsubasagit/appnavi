<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自治体DXアプリ - Navi 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- Firebase設定 -->
    <script src="firebase-config.js"></script>
    <!-- Google Sheets API -->
    <script src="google-sheets-api.js"></script>
</head>
<body class="bg-slate-100 text-slate-900">
    <div id="app-root" class="flex h-screen flex-col">
        <header class="bg-white border-b border-slate-200">
            <div class="mx-auto flex max-w-7xl items-center justify-between px-6 py-4">
                <div class="flex w-72 items-center pl-4">
                    <a id="back-to-dashboard-link" href="index.html" class="mr-3 inline-flex shrink-0 items-center rounded-full border border-slate-200 p-2 text-slate-700 shadow hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m15.75 19.5-7.5-7.5 7.5-7.5" />
                        </svg>
                    </a>
                    <h1 id="view-title" class="text-2xl font-bold text-slate-900">サンプルアプリ</h1>
                    </div>
                <div id="header-controls" class="flex flex-shrink-0 items-center space-x-6">
                    <div id="search-bar" class="relative hidden shrink-0 md:block">
                        <div class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-5 w-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-4.35-4.35M19.125 10.063a6.563 6.563 0 1 1-13.125 0 6.563 6.563 0 0 1 13.125 0Z" />
                            </svg>
                        </div>
                        <input type="search" placeholder="台帳内を検索..." class="w-64 rounded-full border border-slate-200 bg-slate-50 py-2 pl-10 pr-4 text-sm text-slate-700 shadow-inner outline-none focus:border-blue-400 focus:bg-white focus:ring-2 focus:ring-blue-200" />
                    </div>
                    <div id="builder-actions" class="hidden shrink-0 flex items-center space-x-2">
                        <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">プレビュー</button>
                        <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">履歴</button>
                        <button class="rounded-lg bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-green-700">公開</button>
                    </div>
                </div>
            </div>
        </header>
        <div class="flex flex-1 overflow-hidden">
            <!-- 最左縦タブ -->
            <nav class="flex w-16 flex-col border-r border-slate-200 bg-slate-50">
                <button id="tab-data" class="tab-button flex flex-col items-center justify-center border-b border-slate-200 px-3 py-4 text-xs font-semibold text-blue-600 transition-colors hover:bg-white active:bg-blue-50" data-tab="data">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mb-1 h-6 w-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 0 0-1.883 2.542l.857 6a2.25 2.25 0 0 0 2.227 1.932H19.05a2.25 2.25 0 0 0 2.227-1.932l.857-6a2.25 2.25 0 0 0-1.883-2.542m-16.5 0V6A2.25 2.25 0 0 1 6 3.75h3.879a1.5 1.5 0 0 1 1.06.44l2.122 2.12a1.5 1.5 0 0 0 1.06.44H18A2.25 2.25 0 0 1 20.25 9v.776" />
                    </svg>
                    <span>データ</span>
                </button>
                <button id="tab-ui" class="tab-button flex flex-col items-center justify-center border-b border-slate-200 px-3 py-4 text-xs font-semibold text-slate-500 transition-colors hover:bg-white hover:text-blue-600 active:bg-blue-50" data-tab="ui">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mb-1 h-6 w-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.4 2.245 4.5 4.5 0 0 0 8.4-2.245c0-.399-.078-.78-.22-1.128Zm0 0a15.998 15.998 0 0 0 3.388-1.62m-5.043-.025a15.994 15.994 0 0 1 1.622-3.395m3.42 3.42a15.995 15.995 0 0 0 4.764-4.648l3.876-5.814a1.151 1.151 0 0 0-1.597-1.597L14.146 6.32a15.996 15.996 0 0 0-4.649 4.763m3.42 3.42a6.776 6.776 0 0 0-3.42-3.42" />
                    </svg>
                    <span>UI</span>
                </button>
                <button id="tab-chart" class="tab-button flex flex-col items-center justify-center border-b border-slate-200 px-3 py-4 text-xs font-semibold text-slate-500 transition-colors hover:bg-white hover:text-blue-600 active:bg-blue-50" data-tab="chart">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mb-1 h-6 w-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                    </svg>
                    <span>グラフ</span>
                </button>
                <button id="tab-settings" class="tab-button flex flex-col items-center justify-center px-3 py-4 text-xs font-semibold text-slate-500 transition-colors hover:bg-white hover:text-blue-600 active:bg-blue-50" data-tab="settings">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mb-1 h-6 w-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                    <span>設定</span>
                </button>
            </nav>
            <!-- サイドバーコンテンツ（データ） -->
            <aside id="sidebar-data" class="flex w-72 flex-col border-r border-slate-200 bg-white">
                <div class="border-b border-slate-200 px-4 py-4">
                    <button id="data-add-button" class="flex w-full items-center justify-center space-x-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-5 w-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
                        </svg>
                        <span>データを追加</span>
                    </button>
                </div>
                <nav class="flex-1 overflow-auto px-3 py-4 text-sm">
                    <section class="space-y-2">
                        <p class="px-3 text-xs font-semibold uppercase tracking-wide text-slate-400">データテーブル</p>
                        <button id="table-reservations" class="data-table-button flex w-full items-center justify-between rounded-lg bg-blue-50 px-3 py-2 text-blue-700 shadow-sm" data-table="reservations">
                            <span class="font-semibold">施設予約一覧</span>
                            <span class="rounded-full bg-white px-2 py-0.5 text-xs font-semibold text-blue-500">稼働</span>
                        </button>
                    </section>
                </nav>
                <div class="mt-auto border-t border-slate-200 px-4 py-4">
                    <div class="flex items-center justify-center text-sm font-semibold text-slate-600">
                        <span>AppNavi</span>
                    </div>
                </div>
            </aside>
            <!-- サイドバーコンテンツ（UI） -->
            <aside id="sidebar-ui" class="hidden w-72 flex-col border-r border-slate-200 bg-white">
                <div class="border-b border-slate-200 px-4 py-4">
                    <button id="add-page-button" class="flex w-full items-center justify-center space-x-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-5 w-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
                        </svg>
                        <span>ページを追加</span>
                        </button>
                </div>
                <div class="flex-1 overflow-auto px-3 py-4 text-sm">
                    <section class="space-y-2">
                        <div class="flex items-center justify-between px-3 mb-2">
                            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">ページ構造</p>
                            <span class="text-xs text-slate-400">ドラッグで並び替え</span>
                        </div>
                        <div id="page-list" class="space-y-1">
                            <div class="page-item flex w-full items-center justify-between rounded-lg bg-blue-50 px-3 py-2 text-blue-700 shadow-sm cursor-move" data-page-id="page-1" draggable="true">
                                <span class="font-semibold">予約フォーム</span>
                                <div class="flex items-center space-x-1">
                                    <button class="page-delete rounded p-1 text-slate-400 hover:text-red-600 hover:bg-red-50">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                        </svg>
                        </button>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4 text-slate-400">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                                    </svg>
                                </div>
                            </div>
                            <div class="page-item flex w-full items-center justify-between rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100 cursor-move" data-page-id="page-2" draggable="true">
                                <span>予約カレンダー</span>
                                <div class="flex items-center space-x-1">
                                    <button class="page-delete rounded p-1 text-slate-400 hover:text-red-600 hover:bg-red-50">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                        </svg>
                        </button>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4 text-slate-400">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                                    </svg>
                                </div>
                            </div>
                            <div class="page-item flex w-full items-center justify-between rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100 cursor-move" data-page-id="page-3" draggable="true">
                                <span>承認ダッシュボード</span>
                                <div class="flex items-center space-x-1">
                                    <button class="page-delete rounded p-1 text-slate-400 hover:text-red-600 hover:bg-red-50">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4 text-slate-400">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="mt-6 space-y-2">
                        <p class="px-3 text-xs font-semibold uppercase tracking-wide text-slate-400">コンポーネント</p>
                        <button class="flex w-full items-center rounded-lg border border-dashed border-slate-300 px-3 py-2 text-slate-600 hover:border-blue-400 hover:text-blue-600">
                            <span>入力フィールド</span>
                        </button>
                        <button class="flex w-full items-center rounded-lg border border-dashed border-slate-300 px-3 py-2 text-slate-600 hover:border-blue-400 hover:text-blue-600">
                            <span>ドロップダウン</span>
                        </button>
                        <button class="flex w-full items-center rounded-lg border border-dashed border-slate-300 px-3 py-2 text-slate-600 hover:border-blue-400 hover:text-blue-600">
                            <span>カレンダー</span>
                        </button>
                        <button class="flex w-full items-center rounded-lg border border-dashed border-slate-300 px-3 py-2 text-slate-600 hover:border-blue-400 hover:text-blue-600">
                            <span>メトリクスカード</span>
                        </button>
                        <button class="flex w-full items-center rounded-lg border border-dashed border-slate-300 px-3 py-2 text-slate-600 hover:border-blue-400 hover:text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mr-2 h-4 w-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                            </svg>
                            <span>グラフ</span>
                        </button>
                    </section>
                </div>
                <div class="mt-auto border-t border-slate-200 px-4 py-4">
                    <div class="flex items-center justify-center text-sm font-semibold text-slate-600">
                        <span>AppNavi</span>
                    </div>
                </div>
            </aside>
            <!-- サイドバーコンテンツ（グラフ） -->
            <aside id="sidebar-chart" class="hidden w-72 flex-col border-r border-slate-200 bg-white">
                <div class="flex-1 overflow-auto px-3 py-4 text-sm">
                    <section class="space-y-2">
                        <p class="px-3 text-xs font-semibold uppercase tracking-wide text-slate-400">グラフ設定</p>
                        <div class="px-3 py-2 space-y-3">
                            <div>
                                <label class="text-xs font-semibold text-slate-500 mb-1 block">グラフタイプ</label>
                                <select id="chart-type" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-200">
                                    <option value="bar">棒グラフ</option>
                                    <option value="line">折れ線グラフ</option>
                                    <option value="pie">円グラフ</option>
                                    <option value="doughnut">ドーナツグラフ</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500 mb-1 block">集計方法</label>
                                <select id="chart-group-by" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-200">
                                    <option value="status">ステータス別</option>
                                    <option value="department">申請部署別</option>
                                    <option value="facility">予約施設別</option>
                                    <option value="date">日付別</option>
                                </select>
                            </div>
                        </div>
                    </section>
                    <section class="mt-6 space-y-2">
                        <p class="px-3 text-xs font-semibold uppercase tracking-wide text-slate-400">データテーブル</p>
                        <button class="data-table-button flex w-full items-center justify-between rounded-lg bg-blue-50 px-3 py-2 text-blue-700 shadow-sm" data-table="reservations">
                            <span class="font-semibold">施設予約一覧</span>
                        </button>
                    </section>
                </div>
                <div class="mt-auto border-t border-slate-200 px-4 py-4">
                    <div class="flex items-center justify-center text-sm font-semibold text-slate-600">
                        <span>AppNavi</span>
                    </div>
                </div>
            </aside>
            <!-- サイドバーコンテンツ（設定） -->
            <aside id="sidebar-settings" class="hidden w-72 flex-col border-r border-slate-200 bg-white">
                <div class="flex-1 overflow-auto px-3 py-4 text-sm">
                    <section class="space-y-2">
                        <p class="px-3 text-xs font-semibold uppercase tracking-wide text-slate-400">アプリ設定</p>
                        <button id="settings-btn-general" class="settings-sidebar-btn flex w-full items-center rounded-lg bg-blue-50 px-3 py-2 text-blue-700 shadow-sm" data-settings="general">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mr-2 h-5 w-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.7 2.272a.75.75 0 0 1 .6 0l7.5 3.3a.75.75 0 0 1 .45.689v6.676a3.75 3.75 0 0 1-1.977 3.31l-6.573 3.513a.75.75 0 0 1-.7 0l-6.573-3.513A3.75 3.75 0 0 1 3 12.937V6.261a.75.75 0 0 1 .45-.69l7.5-3.299Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" />
                            </svg>
                            <span>全般設定</span>
                        </button>
                        <button id="settings-btn-api" class="settings-sidebar-btn flex w-full items-center rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100" data-settings="api">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mr-2 h-5 w-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75V11.25m0 1.5v1.5m0-1.5H7.5m1.5 0h1.5M15 12.75V11.25m0 1.5v1.5m0-1.5h-1.5m1.5 0h1.5M4.5 6.75h15m-13.5 0v10.5a2.25 2.25 0 0 0 2.25 2.25h6a2.25 2.25 0 0 0 2.25-2.25V6.75" />
                            </svg>
                            <span>API・連携 (PAI)</span>
                        </button>
                        <button id="settings-btn-ai" class="settings-sidebar-btn flex w-full items-center rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100" data-settings="ai">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mr-2 h-5 w-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6.75 6.75 0 1 0 0-13.5 6.75 6.75 0 0 0 0 13.5Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3l1.5 1.5" />
                            </svg>
                            <span>AI ヘルプ設定</span>
                        </button>
                    </section>
                </div>
                <div class="mt-auto border-t border-slate-200 px-4 py-4">
                    <div class="flex items-center justify-center text-sm font-semibold text-slate-600">
                        <span>AppNavi</span>
                    </div>
                </div>
            </aside>
            <main id="data-view" class="flex-1 overflow-auto px-6 py-6">
                <!-- テーブル表示 -->
                <div id="table-display-container" class="rounded-2xl border border-slate-200 bg-white shadow-sm">
                    <div id="table-header" class="flex items-center justify-between px-6 py-4">
                        <div>
                            <h2 id="table-title" class="text-xl font-semibold text-slate-900">施設予約一覧</h2>
                            <p id="table-subtitle" class="text-xs text-slate-500">予約マスタ | 最終更新: 2025/11/12 17:45</p>
                        </div>
                        <div id="table-badges" class="flex space-x-2 text-xs">
                            <span class="inline-flex items-center rounded-full bg-amber-100 px-2 py-1 font-medium text-amber-700">承認待ち 3</span>
                            <span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 font-medium text-emerald-700">承認済み 24</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="data-table" class="min-w-full divide-y divide-slate-200 text-sm">
                            <thead id="table-head" class="bg-slate-50 text-slate-500">
                                <tr>
                                    <th class="px-6 py-3 text-left font-semibold">予約ID</th>
                                    <th class="px-6 py-3 text-left font-semibold">予約施設</th>
                                    <th class="px-6 py-3 text-left font-semibold">申請部署</th>
                                    <th class="px-6 py-3 text-left font-semibold">予約者</th>
                                    <th class="px-6 py-3 text-left font-semibold">開始日時</th>
                                    <th class="px-6 py-3 text-left font-semibold">終了時間</th>
                                    <th class="px-6 py-3 text-left font-semibold">ステータス</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-slate-100 bg-white text-slate-700">
                                <!-- テーブルデータがここに動的に挿入されます -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
            <!-- グラフ表示ビュー -->
            <main id="chart-view" class="hidden flex-1 overflow-auto px-6 py-6">
                <div class="space-y-6">
                    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                        <div class="mb-4">
                            <h2 class="text-xl font-semibold text-slate-900">データ可視化</h2>
                            <p class="text-xs text-slate-500">施設予約一覧のデータをグラフで表示</p>
                        </div>
                        <div class="h-80">
                            <canvas id="data-chart"></canvas>
                    </div>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                            <h3 class="text-sm font-semibold text-slate-700 mb-4">集計サマリー</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">総予約数</span>
                                    <span class="text-lg font-semibold text-slate-900">27</span>
                            </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">承認済み</span>
                                    <span class="text-lg font-semibold text-emerald-600">24</span>
                        </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">承認待ち</span>
                                    <span class="text-lg font-semibold text-amber-600">3</span>
                                </div>
                        </div>
                    </div>
                        <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                            <h3 class="text-sm font-semibold text-slate-700 mb-4">時系列トレンド</h3>
                            <div class="h-48">
                                <canvas id="trend-chart"></canvas>
                            </div>
                    </div>
                            </div>
                        </div>
            </main>
            <section id="builder-view" class="hidden flex flex-1 overflow-hidden bg-slate-100">
                <div class="flex h-full w-full">
                    <div class="flex-1 overflow-auto bg-slate-50 p-6">
                        <div id="auto-generated-form" class="mx-auto max-w-3xl space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow">
                            <!-- 自動生成フォームがここに表示されます -->
                            <div class="grid grid-cols-2 gap-4" id="default-form">
                                <div>
                                    <label class="text-xs font-semibold text-slate-500">予約施設</label>
                                    <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option>第1会議室 (12名)</option>
                                        <option>第2会議室 (8名)</option>
                                        <option>公用車 (市民課)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-slate-500">利用部署</label>
                                    <input type="text" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" value="税務課" />
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-slate-500">予約者</label>
                                    <input type="text" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" value="佐々木 太郎" />
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-slate-500">連絡先</label>
                                    <input type="tel" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" value="03-1234-5678" />
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-semibold text-slate-500">開始日時</label>
                                    <input type="datetime-local" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" value="2025-11-20T09:00" />
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-slate-500">終了日時</label>
                                    <input type="time" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" value="11:00" />
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500">利用目的</label>
                                <textarea rows="4" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="打合せの内容を入力してください"></textarea>
                            </div>
                            <div class="flex items-center justify-between">
                                <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-500 hover:bg-slate-100">下書き保存</button>
                                <div class="space-x-2">
                                    <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">承認経路を編集</button>
                                    <button class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text白 shadow hover:bg-blue-700">申請を送信</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    <aside id="builder-properties" class="w-80 flex-shrink-0 border-l border-slate-200 bg-white p-4 overflow-auto">
                        <h3 class="text-sm font-semibold text-slate-700">プロパティ</h3>
                        <div class="mt-3 space-y-4 text-sm">
                            <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
                                <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">対象フィールド</p>
                                <p class="mt-1 text-lg font-semibold text-slate-900">予約施設</p>
                                <p class="text-xs text-slate-500">ドロップダウン | 施設マスタ</p>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500">ラベル名</label>
                                <input type="text" value="予約施設" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500">プレースホルダー</label>
                                <input type="text" value="会議室を選択してください" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500">データソース</label>
                                <div class="mt-1 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2">
                                    <p class="text-sm font-semibold text-slate-700">会議室マスタ</p>
                                    <p class="text-xs text-slate-500">フィールド: 施設名 / 定員 / 設備</p>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500">バリデーション</label>
                                <div class="mt-1 space-y-2">
                                    <label class="flex items-center space-x-2 text-slate-600">
                                        <input type="checkbox" checked class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" />
                                        <span>必須入力</span>
                                    </label>
                                    <label class="flex items-center space-x-2 text-slate-600">
                                        <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" />
                                        <span>管理者のみ編集可能</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500">アクション</label>
                                <ul class="mt-2 space-y-2 text-xs text-slate-600">
                                    <li>・値変更時に重複予約チェック</li>
                                    <li>・承認ワークフローを更新</li>
                                </ul>
                                <button class="mt-3 w全 rounded-lg border border-dashed border-slate-300 px-4 py-2 text-sm text-slate-500 hover:border-blue-400 hover:text-blue-600">＋ アクションを追加</button>
                            </div>
                        </div>
                    </aside>
                </div>
            </section>
            <!-- 設定表示ビュー -->
            <main id="settings-view" class="hidden flex-1 overflow-auto bg-slate-50 px-6 py-6">
                <!-- 全般設定 -->
                <div id="settings-general" class="settings-content rounded-2xl border border-slate-200 bg-white p-6 shadow-sm max-w-4xl">
                        <h2 class="text-xl font-semibold text-slate-900 mb-6">全般設定</h2>
                        <div class="space-y-6">
                            <div>
                                <label class="text-sm font-semibold text-slate-700 mb-2 block">アプリ名</label>
                                <input type="text" id="settings-app-name" class="w-full rounded-lg border border-slate-300 px-4 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="アプリ名を入力" />
                                <p class="mt-1 text-xs text-slate-500">ダッシュボードに表示されるアプリ名です</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700 mb-2 block">説明</label>
                                <textarea id="settings-app-description" rows="3" class="w-full rounded-lg border border-slate-300 px-4 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="アプリの説明を入力"></textarea>
                                <p class="mt-1 text-xs text-slate-500">アプリの用途や目的を簡潔に説明してください</p>
                            </div>
                            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-slate-200">
                                <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100">キャンセル</button>
                                <button id="settings-save-btn" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-700">保存</button>
                            </div>
                        </div>
                    </div>
                <!-- API・連携設定 -->
                <div id="settings-api" class="settings-content hidden rounded-2xl border border-slate-200 bg-white p-6 shadow-sm max-w-4xl">
                        <h2 class="text-xl font-semibold text-slate-900 mb-6">API・連携設定</h2>
                        <div class="space-y-6">
                            <div class="rounded-xl border border-blue-100 bg-blue-50 px-4 py-3">
                                <p class="text-sm font-semibold text-blue-900">Googleスプレッドシート連携</p>
                                <p class="mt-1 text-xs text-blue-700">Googleスプレッドシートと連携して、データを自動同期できます</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700 mb-2 block">スプレッドシートURL</label>
                                <input type="text" id="settings-sheet-url" class="w-full rounded-lg border border-slate-300 px-4 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="https://docs.google.com/spreadsheets/d/..." />
                                <p class="mt-1 text-xs text-slate-500">共有設定を「リンクを知っている全員」に変更してください</p>
                            </div>
                            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-slate-200">
                                <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100">キャンセル</button>
                                <button class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-700">連携を開始</button>
                            </div>
                        </div>
                    </div>
                <!-- AIヘルプ設定 -->
                <div id="settings-ai" class="settings-content hidden rounded-2xl border border-slate-200 bg-white p-6 shadow-sm max-w-4xl">
                        <h2 class="text-xl font-semibold text-slate-900 mb-6">AI ヘルプ設定</h2>
                        <div class="space-y-6">
                            <div class="rounded-xl border border-amber-100 bg-amber-50 px-4 py-3">
                                <p class="text-sm font-semibold text-amber-900">AIアシスタント機能</p>
                                <p class="mt-1 text-xs text-amber-700">AIが操作をサポートし、質問に答えます</p>
                            </div>
                            <div>
                                <label class="flex items-center space-x-2 text-slate-700">
                                    <input type="checkbox" id="settings-ai-enabled" checked class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" />
                                    <span class="text-sm font-semibold">AIヘルプを有効にする</span>
                                </label>
                                <p class="mt-1 text-xs text-slate-500">AIアシスタントが操作をガイドします</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700 mb-2 block">ヘルプレベル</label>
                                <select id="settings-ai-level" class="w-full rounded-lg border border-slate-300 px-4 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">
                                    <option value="basic">基本（必要最小限の案内）</option>
                                    <option value="detailed" selected>詳細（詳しい説明とヒント）</option>
                                    <option value="full">完全（すべての操作をガイド）</option>
                                </select>
                            </div>
                            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-slate-200">
                                <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100">キャンセル</button>
                                <button class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-700">保存</button>
                            </div>
                        </div>
                    </div>
            </main>
        </div>
    </div>

    <div id="data-add-modal" class="pointer-events-none fixed inset-0 z-40 hidden items-center justify-center bg-slate-900/60 px-4 py-8">
        <div class="pointer-events-auto w-full max-w-3xl rounded-2xl bg-white shadow-2xl">
            <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
                <div>
                    <h3 class="text-lg font-semibold text-slate-900">データを追加</h3>
                    <p class="text-xs text-slate-500" id="modal-table-name">選択したテーブルに新しいデータを追加します。</p>
                </div>
                <button id="data-add-modal-close" class="rounded-full border border-slate-200 p-2 text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="px-6 py-6">
                <div class="space-y-4 text-sm text-slate-600">
                    <div class="rounded-xl border border-blue-100 bg-blue-50 px-5 py-4">
                        <p class="font-semibold text-blue-900">データ追加方法を選択</p>
                        <div class="mt-4 space-y-3">
                            <button class="flex w-full items-center justify-between rounded-lg border border-blue-200 bg-white px-4 py-3 text-sm hover:border-blue-400 hover:bg-blue-50">
                                <span class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-5 w-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
                                    </svg>
                                    <span>手動で入力</span>
                                </span>
                            </button>
                            <button class="flex w-full items-center justify-between rounded-lg border border-blue-200 bg-white px-4 py-3 text-sm hover:border-blue-400 hover:bg-blue-50">
                                <span class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-5 w-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75 9 17.25l10.5-10.5M12 3.75v12" />
                                    </svg>
                                    <span>Excelからインポート</span>
                                </span>
                            </button>
                            <button class="flex w-full items-center justify-between rounded-lg border border-blue-200 bg-white px-4 py-3 text-sm hover:border-blue-400 hover:bg-blue-50">
                                <span class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-5 w-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                    </svg>
                                    <span>CSVからインポート</span>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex items-center justify-end space-x-2">
                    <button id="data-add-modal-cancel" class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // タブ要素
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabData = document.getElementById('tab-data');
            const tabUI = document.getElementById('tab-ui');
            const tabChart = document.getElementById('tab-chart');
            const tabSettings = document.getElementById('tab-settings');
            
            // サイドバー要素
            const sidebarData = document.getElementById('sidebar-data');
            const sidebarUI = document.getElementById('sidebar-ui');
            const sidebarChart = document.getElementById('sidebar-chart');
            const sidebarSettings = document.getElementById('sidebar-settings');
            
            // ビュー要素
            const dataView = document.getElementById('data-view');
            const builderView = document.getElementById('builder-view');
            const chartView = document.getElementById('chart-view');
            const settingsView = document.getElementById('settings-view');
            
            // ヘッダー要素
            const builderActions = document.getElementById('builder-actions');
            const searchBar = document.getElementById('search-bar');
            const backToDashboardLink = document.getElementById('back-to-dashboard-link');
            const viewTitle = document.getElementById('view-title');
            
            // データ追加関連
            const dataAddButton = document.getElementById('data-add-button');
            const dataTableButtons = document.querySelectorAll('.data-table-button');
            const dataAddModal = document.getElementById('data-add-modal');
            const dataAddModalClose = document.getElementById('data-add-modal-close');
            const dataAddModalCancel = document.getElementById('data-add-modal-cancel');
            let selectedTable = null;
            
            // グラフ関連
            let dataChart = null;
            let trendChart = null;
            const chartTypeSelect = document.getElementById('chart-type');
            const chartGroupBySelect = document.getElementById('chart-group-by');

            // タブ切り替え関数
            const setTab = (tabName) => {
                // すべてのタブのスタイルをリセット
                tabButtons.forEach(btn => {
                    btn.classList.remove('bg-white', 'text-blue-600');
                    btn.classList.add('text-slate-500');
                });
                
                // すべてのサイドバーを非表示
                sidebarData.classList.add('hidden');
                sidebarUI.classList.add('hidden');
                sidebarChart.classList.add('hidden');
                sidebarSettings.classList.add('hidden');
                
                // すべてのビューを非表示
                dataView.classList.add('hidden');
                builderView.classList.add('hidden');
                chartView.classList.add('hidden');
                settingsView.classList.add('hidden');
                
                // 選択されたタブに応じて表示を切り替え
                if (tabName === 'data') {
                    tabData.classList.remove('text-slate-500');
                    tabData.classList.add('bg-white', 'text-blue-600');
                    sidebarData.classList.remove('hidden');
                    dataView.classList.remove('hidden');
                    builderActions.classList.add('hidden');
                    searchBar.classList.remove('hidden');
                    backToDashboardLink.classList.remove('hidden');
                    viewTitle.textContent = 'サンプルアプリ';
                } else if (tabName === 'ui') {
                    tabUI.classList.remove('text-slate-500');
                    tabUI.classList.add('bg-white', 'text-blue-600');
                    sidebarUI.classList.remove('hidden');
                    builderView.classList.remove('hidden');
                    builderActions.classList.remove('hidden');
                    searchBar.classList.add('hidden');
                    backToDashboardLink.classList.remove('hidden');
                    viewTitle.textContent = 'サンプルアプリ';
                } else if (tabName === 'chart') {
                    tabChart.classList.remove('text-slate-500');
                    tabChart.classList.add('bg-white', 'text-blue-600');
                    sidebarChart.classList.remove('hidden');
                    chartView.classList.remove('hidden');
                    builderActions.classList.add('hidden');
                    searchBar.classList.remove('hidden');
                    backToDashboardLink.classList.remove('hidden');
                    viewTitle.textContent = 'グラフ';
                    initCharts();
                } else if (tabName === 'settings') {
                    tabSettings.classList.remove('text-slate-500');
                    tabSettings.classList.add('bg-white', 'text-blue-600');
                    sidebarSettings.classList.remove('hidden');
                    settingsView.classList.remove('hidden');
                    builderActions.classList.add('hidden');
                    searchBar.classList.remove('hidden');
                    backToDashboardLink.classList.remove('hidden');
                    viewTitle.textContent = 'アプリ設定';
                    // デフォルトで全般設定を表示
                    showSettingsContent('general');
                }
            };

            // タブボタンのイベントリスナー
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    setTab(tabName);
                });
            });

            // テーブルデータ定義
            const tableData = {
                'reservations': {
                    name: '施設予約一覧',
                    subtitle: '予約マスタ | 最終更新: 2025/11/12 17:45',
                    badges: [
                        { text: '承認待ち 3', class: 'bg-amber-100 text-amber-700' },
                        { text: '承認済み 24', class: 'bg-emerald-100 text-emerald-700' }
                    ],
                    headers: ['予約ID', '予約施設', '申請部署', '予約者', '開始日時', '終了時間', 'ステータス'],
                    rows: [
                        ['R-201', '第1会議室 (12名)', '税務課', '佐々木 太郎', '2025/11/20 09:00', '11:00', '<span class="inline-flex items-center rounded-full bg-amber-100 px-2 py-1 text-xs font-semibold text-amber-700">承認待ち</span>'],
                        ['R-202', '公用車 (市民課)', '市民課', '山本 花子', '2025/11/21 13:00', '16:00', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">承認済</span>'],
                        ['R-203', '大会議室 (30名)', '企画課', '井上 修', '2025/11/22 15:00', '18:00', '<span class="inline-flex items-center rounded-full bg-sky-100 px-2 py-1 text-xs font-semibold text-sky-700">申請中</span>']
                    ]
                },
                'equipment': {
                    name: '備品管理台帳',
                    subtitle: '備品マスタ | 最終更新: 2025/11/12 17:45',
                    badges: [
                        { text: '総数 45', class: 'bg-blue-100 text-blue-700' },
                        { text: '貸出中 12', class: 'bg-violet-100 text-violet-700' }
                    ],
                    headers: ['備品ID', '備品名', 'カテゴリ', '保管場所', '状態', '貸出状況', '最終更新日'],
                    rows: [
                        ['E-001', 'ノートPC (ThinkPad)', 'PC機器', '2階倉庫', '良好', '貸出中', '2025/11/10'],
                        ['E-002', 'プロジェクター EPSON', 'AV機器', '3階倉庫', '良好', '利用可能', '2025/11/08'],
                        ['E-003', 'ホワイトボード 180cm', '事務用品', '第1会議室', '良好', '貸出中', '2025/11/05'],
                        ['E-004', 'コピー機 複合機', '事務機器', '1階オフィス', 'メンテ中', '利用不可', '2025/11/12'],
                        ['E-005', 'モニター 27インチ', 'PC機器', '2階倉庫', '良好', '利用可能', '2025/11/09']
                    ]
                },
                'users': {
                    name: '利用者マスタ',
                    subtitle: 'ユーザーマスタ | 最終更新: 2025/11/12 17:45',
                    badges: [
                        { text: '総数 156', class: 'bg-blue-100 text-blue-700' },
                        { text: '有効 148', class: 'bg-emerald-100 text-emerald-700' }
                    ],
                    headers: ['ユーザーID', '氏名', '所属部署', 'メールアドレス', '権限', '最終ログイン', 'ステータス'],
                    rows: [
                        ['U-001', '田中 一郎', '総務課', 'tanaka@city.example.jp', '一般', '2025/11/12 09:30', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">有効</span>'],
                        ['U-002', '鈴木 花子', '市民課', 'suzuki@city.example.jp', '管理者', '2025/11/12 10:15', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">有効</span>'],
                        ['U-003', '佐藤 太郎', '税務課', 'sato@city.example.jp', '一般', '2025/11/11 16:45', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">有効</span>'],
                        ['U-004', '高橋 美咲', '企画課', 'takahashi@city.example.jp', '一般', '2025/11/10 14:20', '<span class="inline-flex items-center rounded-full bg-amber-100 px-2 py-1 text-xs font-semibold text-amber-700">一時停止</span>'],
                        ['U-005', '伊藤 健太', '環境課', 'ito@city.example.jp', '一般', '2025/11/12 11:00', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">有効</span>']
                    ]
                },
                'rooms': {
                    name: '会議室マスタ',
                    subtitle: '施設マスタ | 最終更新: 2025/11/12 17:45',
                    badges: [
                        { text: '総数 8', class: 'bg-blue-100 text-blue-700' },
                        { text: '利用可能 5', class: 'bg-emerald-100 text-emerald-700' }
                    ],
                    headers: ['施設ID', '施設名', '定員', '設備', '所在地', '予約可能時間', '状態'],
                    rows: [
                        ['R-101', '第1会議室', '12名', 'プロジェクター、ホワイトボード', '本庁舎2階', '平日 9:00-18:00', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">利用可能</span>'],
                        ['R-102', '第2会議室', '8名', 'ホワイトボード', '本庁舎2階', '平日 9:00-18:00', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">利用可能</span>'],
                        ['R-103', '大会議室', '30名', 'プロジェクター、音響設備', '本庁舎3階', '平日 9:00-18:00', '<span class="inline-flex items-center rounded-full bg-amber-100 px-2 py-1 text-xs font-semibold text-amber-700">メンテナンス中</span>'],
                        ['R-201', '公用車 (市民課)', '7名', 'ETC、カーナビ', '駐車場A', '平日 8:00-20:00', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">利用可能</span>'],
                        ['R-202', '公用車 (総務課)', '5名', 'ETC、カーナビ', '駐車場A', '平日 8:00-20:00', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">利用可能</span>']
                    ]
                }
            };

            // テーブル表示更新関数
            function updateTableDisplay(tableKey) {
                const data = tableData[tableKey];
                if (!data) return;

                const tableTitle = document.getElementById('table-title');
                const tableSubtitle = document.getElementById('table-subtitle');
                const tableBadges = document.getElementById('table-badges');
                const tableHead = document.getElementById('table-head');
                const tableBody = document.getElementById('table-body');

                if (tableTitle) tableTitle.textContent = data.name;
                if (tableSubtitle) tableSubtitle.textContent = data.subtitle;

                // バッジ更新
                if (tableBadges) {
                    tableBadges.innerHTML = data.badges.map(badge => 
                        `<span class="inline-flex items-center rounded-full px-2 py-1 font-medium ${badge.class}">${badge.text}</span>`
                    ).join('');
                }

                // ヘッダー更新
                if (tableHead) {
                    const headerRow = tableHead.querySelector('tr');
                    if (headerRow) {
                        headerRow.innerHTML = data.headers.map(header => 
                            `<th class="px-6 py-3 text-left font-semibold">${header}</th>`
                        ).join('');
                    }
                }

                // ボディ更新
                if (tableBody) {
                    tableBody.innerHTML = data.rows.map((row, index) => {
                        const firstCell = row[0];
                        const isLink = firstCell.startsWith('R-') || firstCell.startsWith('E-') || firstCell.startsWith('U-');
                        const firstCellHTML = isLink ? `<td class="px-6 py-4 font-semibold text-blue-600">${firstCell}</td>` : `<td class="px-6 py-4 font-semibold text-blue-600">${firstCell}</td>`;
                        
                        return `<tr class="hover:bg-slate-50">
                            ${firstCellHTML}
                            ${row.slice(1).map(cell => `<td class="px-6 py-4">${cell}</td>`).join('')}
                        </tr>`;
                    }).join('');
                }

                // ヘッダータイトルも更新
                if (viewTitle) {
                    viewTitle.textContent = data.name;
                }
            }

            const tableNames = {
                'reservations': '施設予約一覧',
                'equipment': '備品管理台帳',
                'users': '利用者マスタ',
                'rooms': '会議室マスタ'
            };

            dataTableButtons.forEach(button => {
                button.addEventListener('click', () => {
                    dataTableButtons.forEach(b => {
                        b.classList.remove('bg-blue-50', 'text-blue-700', 'shadow-sm');
                        b.classList.add('text-slate-600');
                    });
                    button.classList.add('bg-blue-50', 'text-blue-700', 'shadow-sm');
                    button.classList.remove('text-slate-600');
                    selectedTable = button.dataset.table;
                    
                    // テーブル表示を更新
                    updateTableDisplay(selectedTable);
                    
                    const modalTableName = document.getElementById('modal-table-name');
                    if (modalTableName && tableNames[selectedTable]) {
                        modalTableName.textContent = `${tableNames[selectedTable]}に新しいデータを追加します。`;
                    }
                });
            });

            const openDataAddModal = () => {
                if (!selectedTable) {
                    alert('データテーブルを選択してください');
                    return;
                }
                if (dataAddModal) {
                    dataAddModal.classList.remove('hidden');
                    dataAddModal.classList.add('flex');
                }
            };

            const closeDataAddModal = () => {
                if (dataAddModal) {
                    dataAddModal.classList.remove('flex');
                    dataAddModal.classList.add('hidden');
                }
            };

            if (dataAddButton) {
                dataAddButton.addEventListener('click', openDataAddModal);
            }
            if (dataAddModalClose) {
                dataAddModalClose.addEventListener('click', closeDataAddModal);
            }
            if (dataAddModalCancel) {
                dataAddModalCancel.addEventListener('click', closeDataAddModal);
            }
            if (dataAddModal) {
                dataAddModal.addEventListener('click', (event) => {
                    if (event.target === dataAddModal) {
                        closeDataAddModal();
                    }
                });
            }

            // 初期テーブル表示
            if (dataTableButtons.length > 0) {
                selectedTable = dataTableButtons[0].dataset.table;
                updateTableDisplay(selectedTable);
                dataTableButtons[0].click();
            }

            // グラフ初期化関数
            const initCharts = () => {
                const chartCtx = document.getElementById('data-chart');
                const trendCtx = document.getElementById('trend-chart');
                
                if (!chartCtx || !trendCtx) return;

                // 既存のグラフを破棄
                if (dataChart) {
                    dataChart.destroy();
                }
                if (trendChart) {
                    trendChart.destroy();
                }

                // サンプルデータ（実際の実装では、選択されたテーブルからデータを取得）
                const sampleData = {
                    status: {
                        labels: ['承認済み', '承認待ち', '申請中'],
                        data: [24, 3, 1]
                    },
                    department: {
                        labels: ['税務課', '市民課', '企画課'],
                        data: [10, 12, 5]
                    },
                    facility: {
                        labels: ['第1会議室', '公用車', '大会議室'],
                        data: [15, 8, 4]
                    },
                    date: {
                        labels: ['11/20', '11/21', '11/22', '11/23', '11/24'],
                        data: [5, 8, 6, 4, 4]
                    }
                };

                const groupBy = chartGroupBySelect.value;
                const chartType = chartTypeSelect.value;
                const data = sampleData[groupBy] || sampleData.status;

                // メイングラフ
                dataChart = new Chart(chartCtx, {
                    type: chartType === 'doughnut' ? 'doughnut' : chartType === 'pie' ? 'pie' : chartType === 'line' ? 'line' : 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: '件数',
                            data: data.data,
                            backgroundColor: chartType === 'pie' || chartType === 'doughnut' 
                                ? ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                                : '#3b82f6',
                            borderColor: '#1e40af',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false
                            }
                        }
                    }
                });

                // 時系列トレンドグラフ
                trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: ['11/20', '11/21', '11/22', '11/23', '11/24', '11/25'],
                        datasets: [{
                            label: '予約数',
                            data: [5, 8, 6, 4, 4, 7],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            };

            // グラフタイプ・集計方法変更時のイベント
            if (chartTypeSelect) {
                chartTypeSelect.addEventListener('change', () => {
                    if (!chartView.classList.contains('hidden')) {
                        initCharts();
                    }
                });
            }

            if (chartGroupBySelect) {
                chartGroupBySelect.addEventListener('change', () => {
                    if (!chartView.classList.contains('hidden')) {
                        initCharts();
                    }
                });
            }

            // アプリ管理機能（Firebase/Supabase構造を参考）
            let currentApp = null;
            let currentFormData = null;
            let selectedFieldIndex = null;

            // URLパラメータからアプリIDを取得
            const urlParams = new URLSearchParams(window.location.search);
            const appId = urlParams.get('appId');
            const isNewApp = urlParams.get('newApp') === 'true';

            // アプリデータを読み込む
            async function loadApp(appId) {
                try {
                    // データベースサービスが初期化されるまで待つ
                    await databaseService.init();
                    
                    // Firestoreからアプリデータを取得
                    const app = await databaseService.getApp(appId);
                    
                    if (app) {
                        // createdAt/updatedAtがTimestampの場合は変換
                        currentApp = {
                            ...app,
                            createdAt: app.createdAt?.toDate ? app.createdAt.toDate().toISOString() : app.createdAt,
                            updatedAt: app.updatedAt?.toDate ? app.updatedAt.toDate().toISOString() : app.updatedAt
                        };
                        
                        if (viewTitle) {
                            viewTitle.textContent = currentApp.name || 'サンプルアプリ';
                        }
                        // ブラウザタブのタイトルも更新
                        document.title = (currentApp.name || 'サンプルアプリ') + ' - AppNavi';
                        
                        // アプリデータを使用してフォームを生成
                        if (currentApp.columns && currentApp.columns.length > 0) {
                            currentFormData = {
                                name: currentApp.name,
                                columns: currentApp.columns,
                                data: currentApp.data || []
                            };
                            // データタブでデータを表示
                            if (currentApp.data && currentApp.data.length > 0 && currentApp.columns) {
                                updateAppDataTable(currentApp.data, currentApp.columns);
                            }
                        }
                    } else {
                        console.error('App not found:', appId);
                        if (viewTitle) {
                            viewTitle.textContent = 'アプリが見つかりません';
                        }
                        // ブラウザタブのタイトルも更新
                        document.title = 'アプリが見つかりません - AppNavi';
                    }
                } catch (error) {
                    console.error('Error loading app:', error);
                    // フォールバック: localStorageから読み込み
                    const savedApps = localStorage.getItem('apps');
                    if (savedApps) {
                        const apps = JSON.parse(savedApps);
                        currentApp = apps.find(app => app.id === appId);
                        if (currentApp) {
                            if (viewTitle) {
                                viewTitle.textContent = currentApp.name || 'サンプルアプリ';
                            }
                            // ブラウザタブのタイトルも更新
                            document.title = (currentApp.name || 'サンプルアプリ') + ' - AppNavi';
                            if (currentApp.columns && currentApp.columns.length > 0) {
                                currentFormData = {
                                    name: currentApp.name,
                                    columns: currentApp.columns,
                                    data: currentApp.data || []
                                };
                                if (currentApp.data && currentApp.data.length > 0 && currentApp.columns) {
                                    updateAppDataTable(currentApp.data, currentApp.columns);
                                }
                            }
                        }
                    }
                }
            }

            // アプリデータをテーブルに表示
            function updateAppDataTable(data, columns) {
                if (!data || !columns || data.length === 0) return;

                const tableTitle = document.getElementById('table-title');
                const tableSubtitle = document.getElementById('table-subtitle');
                const tableBadges = document.getElementById('table-badges');
                const tableHead = document.getElementById('table-head');
                const tableBody = document.getElementById('table-body');

                // テーブルタイトルを更新
                if (tableTitle && currentApp) {
                    tableTitle.textContent = currentApp.name || 'データ一覧';
                }
                if (tableSubtitle) {
                    const now = new Date();
                    tableSubtitle.textContent = `データマスタ | 最終更新: ${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                }

                // バッジを更新
                if (tableBadges) {
                    tableBadges.innerHTML = `
                        <span class="inline-flex items-center rounded-full bg-blue-100 px-2 py-1 font-medium text-blue-700">総数 ${data.length}</span>
                    `;
                }

                // ヘッダーを更新（カラム名を使用）
                if (tableHead) {
                    const headerRow = tableHead.querySelector('tr');
                    if (headerRow) {
                        headerRow.innerHTML = columns.map(col => 
                            `<th class="px-6 py-3 text-left font-semibold">${col.name}</th>`
                        ).join('');
                    }
                }

                // ボディを更新
                if (tableBody) {
                    tableBody.innerHTML = data.map((row, index) => {
                        const cells = columns.map(col => {
                            const value = row[col.name] || '';
                            return `<td class="px-6 py-4">${value}</td>`;
                        });
                        return `<tr class="hover:bg-slate-50">
                            ${cells.join('')}
                        </tr>`;
                    }).join('');
                }
            }

            // 新規アプリ作成時はフォームを自動生成
            if (isNewApp) {
                const newAppDataStr = sessionStorage.getItem('newAppData');
                if (newAppDataStr) {
                    const newAppData = JSON.parse(newAppDataStr);
                    currentFormData = newAppData;
                    
                    // アプリ名を更新
                    viewTitle.textContent = newAppData.name || '新しいアプリ';
                    // ブラウザタブのタイトルも更新
                    document.title = (newAppData.name || '新しいアプリ') + ' - AppNavi';
                    
                    // フォームを自動生成
                    generateForm(newAppData.columns);
                    
                    // UIタブを選択
                    setTimeout(() => {
                        setTab('ui');
                        // 通知表示
                        showNotification('フォームが自動生成されました。各フィールドをクリックして編集できます。');
                    }, 100);
                    
                    // sessionStorageをクリア
                    sessionStorage.removeItem('newAppData');
                }
            } else if (appId) {
                // 既存のアプリを読み込む（非同期）
                loadApp(appId).then(() => {
                    // アプリ読み込み後に設定フォームを更新
                    updateSettingsForm();
                }).catch(error => {
                    console.error('Error loading app:', error);
                    if (viewTitle) {
                        viewTitle.textContent = 'アプリの読み込みに失敗しました';
                    }
                    // ブラウザタブのタイトルも更新
                    document.title = 'アプリの読み込みに失敗しました - AppNavi';
                });
            } else {
                // アプリIDがない場合はサンプルアプリを表示
                if (viewTitle) {
                    viewTitle.textContent = 'サンプルアプリ';
                }
                // ブラウザタブのタイトルも更新
                document.title = 'サンプルアプリ - AppNavi';
            }

            // フォーム生成関数
            function generateForm(columns) {
                if (!columns || columns.length === 0) return;

                const formContainer = document.getElementById('auto-generated-form');
                const defaultForm = document.getElementById('default-form');
                
                // デフォルトフォームを非表示
                if (defaultForm) {
                    defaultForm.classList.add('hidden');
                }

                // フォーム要素を生成
                let formHTML = '<div class="space-y-6">';
                
                // 2列グリッドで表示
                const gridItems = [];
                
                columns.forEach((col, index) => {
                    const fieldHTML = generateFieldHTML(col, index);
                    gridItems.push(fieldHTML);
                });

                // 2列に分割
                for (let i = 0; i < gridItems.length; i += 2) {
                    formHTML += '<div class="grid grid-cols-2 gap-4">';
                    formHTML += gridItems[i];
                    if (i + 1 < gridItems.length) {
                        formHTML += gridItems[i + 1];
                    } else {
                        formHTML += '<div></div>'; // 空のセル
                    }
                    formHTML += '</div>';
                }

                // 送信ボタン
                formHTML += `
                    <div class="flex items-center justify-end space-x-2 pt-4 border-t border-slate-200">
                        <button type="button" class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">キャンセル</button>
                        <button type="button" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-700">保存</button>
                    </div>
                `;

                formHTML += '</div>';
                
                // 既存のフォームを置き換え
                const existingForm = formContainer.querySelector('.generated-form-content');
                if (existingForm) {
                    existingForm.innerHTML = formHTML;
                } else {
                    const formContent = document.createElement('div');
                    formContent.className = 'generated-form-content';
                    formContent.innerHTML = formHTML;
                    formContainer.insertBefore(formContent, defaultForm);
                    
                    // フィールドクリックイベントを設定
                    setTimeout(() => {
                        setupFieldClickEvents();
                    }, 100);
                }
            }

            // フィールドHTML生成関数
            function generateFieldHTML(column, index) {
                const label = column.name;
                const type = column.type || 'text';
                const required = column.required ? '<span class="text-red-500">*</span>' : '';
                const fieldId = `field-${index}`;
                
                let inputHTML = '';
                
                switch (type) {
                    case 'select':
                        const options = column.options || [];
                        inputHTML = `
                            <select id="${fieldId}" class="form-field mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" data-field-index="${index}">
                                <option value="">選択してください</option>
                                ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        `;
                        break;
                    
                    case 'date':
                        inputHTML = `
                            <input type="date" id="${fieldId}" class="form-field mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" data-field-index="${index}" />
                        `;
                        break;
                    
                    case 'datetime':
                        inputHTML = `
                            <input type="datetime-local" id="${fieldId}" class="form-field mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" data-field-index="${index}" />
                        `;
                        break;
                    
                    case 'number':
                        inputHTML = `
                            <input type="number" id="${fieldId}" class="form-field mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" data-field-index="${index}" />
                        `;
                        break;
                    
                    default: // text
                        inputHTML = `
                            <input type="text" id="${fieldId}" class="form-field mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" data-field-index="${index}" placeholder="${label}を入力" />
                        `;
                }
                
                return `
                    <div class="form-field-wrapper" data-field-index="${index}">
                        <label class="text-xs font-semibold text-slate-500">
                            ${label} ${required}
                        </label>
                        ${inputHTML}
                    </div>
                `;
            }

            // フィールドクリックイベント設定
            function setupFieldClickEvents() {
                const fieldWrappers = document.querySelectorAll('.form-field-wrapper');
                fieldWrappers.forEach(wrapper => {
                    wrapper.addEventListener('click', (e) => {
                        const fieldIndex = parseInt(wrapper.dataset.fieldIndex);
                        if (currentFormData && currentFormData.columns[fieldIndex]) {
                            selectedFieldIndex = fieldIndex;
                            showFieldProperties(currentFormData.columns[fieldIndex]);
                            
                            // 選択状態を表示
                            fieldWrappers.forEach(w => w.classList.remove('ring-2', 'ring-blue-500', 'rounded-lg'));
                            wrapper.classList.add('ring-2', 'ring-blue-500', 'rounded-lg', 'p-2');
                        }
                    });
                });
            }

            // フィールドプロパティ表示
            function showFieldProperties(column) {
                const propertiesPanel = document.getElementById('builder-properties');
                if (!propertiesPanel) return;

                const typeLabels = {
                    'text': 'テキスト',
                    'number': '数値',
                    'date': '日付',
                    'datetime': '日時',
                    'select': '選択肢'
                };

                propertiesPanel.innerHTML = `
                    <h3 class="text-sm font-semibold text-slate-700 mb-4">プロパティ</h3>
                    <div class="space-y-4 text-sm">
                        <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
                            <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">対象フィールド</p>
                            <p class="mt-1 text-lg font-semibold text-slate-900">${column.name}</p>
                            <p class="text-xs text-slate-500">${typeLabels[column.type] || 'テキスト'}</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500">ラベル名</label>
                            <input type="text" value="${column.name}" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500">フィールドタイプ</label>
                            <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <option value="text" ${column.type === 'text' ? 'selected' : ''}>テキスト</option>
                                <option value="number" ${column.type === 'number' ? 'selected' : ''}>数値</option>
                                <option value="date" ${column.type === 'date' ? 'selected' : ''}>日付</option>
                                <option value="datetime" ${column.type === 'datetime' ? 'selected' : ''}>日時</option>
                                <option value="select" ${column.type === 'select' ? 'selected' : ''}>選択肢</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center space-x-2 text-slate-600">
                                <input type="checkbox" ${column.required ? 'checked' : ''} class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" />
                                <span>必須入力</span>
                            </label>
                        </div>
                        ${column.type === 'select' && column.options ? `
                            <div>
                                <label class="text-xs font-semibold text-slate-500">選択肢</label>
                                <div class="mt-1 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 max-h-32 overflow-y-auto">
                                    ${column.options.map(opt => `<p class="text-xs text-slate-600">${opt}</p>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // 通知表示関数
            function showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 z-50 rounded-lg bg-blue-600 px-4 py-3 text-sm text-white shadow-lg';
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            // ページ管理機能
            let pageCounter = 4; // 既存の3ページ + 1
            let selectedPageId = 'page-1';
            let draggedElement = null;

            const addPageButton = document.getElementById('add-page-button');
            const pageList = document.getElementById('page-list');

            // ページ追加機能
            addPageButton?.addEventListener('click', () => {
                const pageId = `page-${pageCounter++}`;
                const pageName = `新しいページ ${pageCounter - 3}`;
                addPage(pageId, pageName);
            });

            function addPage(pageId, pageName) {
                const pageItem = document.createElement('div');
                pageItem.className = 'page-item flex w-full items-center justify-between rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100 cursor-move';
                pageItem.dataset.pageId = pageId;
                pageItem.draggable = true;
                pageItem.innerHTML = `
                    <span>${pageName}</span>
                    <div class="flex items-center space-x-1">
                        <button class="page-delete rounded p-1 text-slate-400 hover:text-red-600 hover:bg-red-50">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                            </svg>
                        </button>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4 text-slate-400">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </div>
                `;
                
                // イベントリスナーを追加
                setupPageItemEvents(pageItem);
                
                // ページリストに追加
                pageList.appendChild(pageItem);
                
                // 新規追加されたページを選択
                selectPage(pageId);
            }

            // ページ選択機能
            function selectPage(pageId) {
                selectedPageId = pageId;
                document.querySelectorAll('.page-item').forEach(item => {
                    if (item.dataset.pageId === pageId) {
                        item.classList.add('bg-blue-50', 'text-blue-700', 'shadow-sm');
                        item.classList.remove('text-slate-600');
                    } else {
                        item.classList.remove('bg-blue-50', 'text-blue-700', 'shadow-sm');
                        item.classList.add('text-slate-600');
                    }
                });
            }

            // ページアイテムのイベント設定
            function setupPageItemEvents(pageItem) {
                // クリックで選択
                pageItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.page-delete')) {
                        selectPage(pageItem.dataset.pageId);
                    }
                });

                // 削除ボタン
                const deleteBtn = pageItem.querySelector('.page-delete');
                deleteBtn?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('このページを削除しますか？')) {
                        pageItem.remove();
                        // 最初のページを選択
                        const firstPage = pageList.querySelector('.page-item');
                        if (firstPage) {
                            selectPage(firstPage.dataset.pageId);
                        }
                    }
                });

                // ドラッグ&ドロップ
                pageItem.addEventListener('dragstart', (e) => {
                    draggedElement = pageItem;
                    pageItem.style.opacity = '0.5';
                });

                pageItem.addEventListener('dragend', () => {
                    pageItem.style.opacity = '1';
                    draggedElement = null;
                });

                pageItem.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== pageItem) {
                        const rect = pageItem.getBoundingClientRect();
                        const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                        pageList.insertBefore(draggedElement, next ? pageItem.nextSibling : pageItem);
                    }
                });

                pageItem.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== pageItem) {
                        pageItem.classList.add('ring-2', 'ring-blue-500');
                    }
                });

                pageItem.addEventListener('dragleave', () => {
                    pageItem.classList.remove('ring-2', 'ring-blue-500');
                });

                pageItem.addEventListener('drop', (e) => {
                    e.preventDefault();
                    pageItem.classList.remove('ring-2', 'ring-blue-500');
                });
            }

            // 既存のページアイテムにイベントを設定
            document.querySelectorAll('.page-item').forEach(item => {
                setupPageItemEvents(item);
            });

            // 設定画面の表示切り替え
            function showSettingsContent(contentType) {
                // すべての設定コンテンツを非表示
                document.querySelectorAll('.settings-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // すべての設定サイドバーボタンのスタイルをリセット
                document.querySelectorAll('.settings-sidebar-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-50', 'text-blue-700', 'shadow-sm');
                    btn.classList.add('text-slate-600');
                });
                
                // 選択された設定コンテンツを表示
                const content = document.getElementById(`settings-${contentType}`);
                if (content) {
                    content.classList.remove('hidden');
                }
                
                // 選択されたサイドバーボタンをハイライト
                const btn = document.getElementById(`settings-btn-${contentType}`);
                if (btn) {
                    btn.classList.add('bg-blue-50', 'text-blue-700', 'shadow-sm');
                    btn.classList.remove('text-slate-600');
                }
            }

            // 設定サイドバーボタンのイベントリスナー
            document.querySelectorAll('.settings-sidebar-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const contentType = btn.dataset.settings;
                    showSettingsContent(contentType);
                });
            });

            // 設定画面の保存機能
            const settingsSaveBtn = document.getElementById('settings-save-btn');
            settingsSaveBtn?.addEventListener('click', async () => {
                if (!appId) {
                    alert('アプリが読み込まれていません');
                    return;
                }

                const appNameInput = document.getElementById('settings-app-name');
                const appDescriptionInput = document.getElementById('settings-app-description');

                if (!appNameInput) {
                    alert('設定画面が読み込まれていません');
                    return;
                }

                const appName = appNameInput.value.trim();
                const appDescription = appDescriptionInput?.value.trim() || '';

                if (!appName) {
                    alert('アプリ名を入力してください');
                    appNameInput.focus();
                    return;
                }

                // ローディング表示
                const originalText = settingsSaveBtn.textContent;
                settingsSaveBtn.disabled = true;
                settingsSaveBtn.textContent = '保存中...';

                try {
                    // データベースサービスが初期化されるまで待つ
                    await databaseService.init();
                    
                    // Firebase/Firestoreでアプリを更新
                    const updatedApp = await databaseService.updateApp(appId, {
                        name: appName,
                        description: appDescription
                    });

                    if (updatedApp) {
                        // 現在のアプリ情報も更新
                        if (currentApp) {
                            currentApp.name = appName;
                            currentApp.description = appDescription;
                        }
                        
                        // ヘッダータイトルも更新
                        if (viewTitle) {
                            viewTitle.textContent = appName;
                        }
                        // ブラウザタブのタイトルも更新
                        document.title = appName + ' - AppNavi';
                        
                        // 通知表示
                        showNotification('設定を保存しました');
                    } else {
                        alert('アプリの更新に失敗しました');
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                    // フォールバック: localStorageで更新
                    const savedApps = localStorage.getItem('apps');
                    if (savedApps) {
                        const apps = JSON.parse(savedApps);
                        const appIndex = apps.findIndex(app => app.id === appId);
                        if (appIndex !== -1) {
                            apps[appIndex].name = appName;
                            apps[appIndex].description = appDescription;
                            apps[appIndex].updatedAt = new Date().toISOString();
                            localStorage.setItem('apps', JSON.stringify(apps));
                            
                            if (viewTitle) {
                                viewTitle.textContent = appName;
                            }
                            // ブラウザタブのタイトルも更新
                            document.title = appName + ' - AppNavi';
                            
                            showNotification('設定を保存しました（ローカル保存）');
                        } else {
                            alert('アプリが見つかりませんでした');
                        }
                    } else {
                        alert('アプリデータが見つかりませんでした');
                    }
                } finally {
                    settingsSaveBtn.disabled = false;
                    settingsSaveBtn.textContent = originalText;
                }
            });

            // アプリ読み込み時に設定画面の値を設定
            function updateSettingsForm() {
                if (currentApp) {
                    const appNameInput = document.getElementById('settings-app-name');
                    const appDescriptionInput = document.getElementById('settings-app-description');
                    if (appNameInput) appNameInput.value = currentApp.name || '';
                    if (appDescriptionInput) appDescriptionInput.value = currentApp.description || '';
                }
            }

            // アプリ読み込み後に設定フォームを更新
            if (currentApp) {
                updateSettingsForm();
            }

            // 設定タブが選択されたときにフォームを更新するため、setTab関数を拡張
            const originalSetTabFunction = setTab;
            window.setTab = function(tabName) {
                originalSetTabFunction(tabName);
                if (tabName === 'settings') {
                    updateSettingsForm();
                }
            };

            // Google Sheets API連携機能
            const settingsSheetUrlInput = document.getElementById('settings-sheet-url');
            const settingsApiConnectBtn = document.querySelector('#settings-api button:last-child');
            
            settingsApiConnectBtn?.addEventListener('click', async () => {
                const sheetUrl = settingsSheetUrlInput?.value.trim();
                
                if (!sheetUrl) {
                    alert('スプレッドシートURLを入力してください');
                    return;
                }

                // URLの検証
                if (!sheetUrl.includes('docs.google.com/spreadsheets')) {
                    alert('有効なGoogleスプレッドシートのURLを入力してください');
                    return;
                }

                // ローディング表示
                const originalText = settingsApiConnectBtn.textContent;
                settingsApiConnectBtn.disabled = true;
                settingsApiConnectBtn.textContent = '接続中...';

                try {
                    // Google Sheets APIサービスの初期化
                    await googleSheetsService.initAuth();
                    
                    // 認証が必要な場合
                    if (!googleSheetsService.isAuthenticated) {
                        const shouldSignIn = confirm('Google認証が必要です。認証を開始しますか？');
                        if (shouldSignIn) {
                            await googleSheetsService.signIn();
                        } else {
                            throw new Error('認証が必要です');
                        }
                    }

                    // スプレッドシートのデータを取得・分析
                    showNotification('スプレッドシートを分析中...', 'info');
                    const analysis = await googleSheetsService.analyzeSpreadsheet(sheetUrl);

                    if (!analysis.headers || analysis.headers.length === 0) {
                        throw new Error('スプレッドシートにデータが見つかりませんでした');
                    }

                    // アプリデータを更新（スプレッドシート連携情報を追加）
                    if (appId && databaseService) {
                        await databaseService.updateApp(appId, {
                            googleSheetsUrl: sheetUrl,
                            googleSheetsLastSynced: new Date().toISOString()
                        });

                        // データを同期
                        if (analysis.rows && analysis.rows.length > 0) {
                            // 列設定を更新（もしデータ型が検出された場合）
                            const columns = analysis.headers.map(header => {
                                const dataType = analysis.dataTypes[header] || { type: 'text' };
                                return {
                                    name: header,
                                    type: dataType.type,
                                    required: false,
                                    options: dataType.options || null
                                };
                            });

                            // アプリデータを更新
                            await databaseService.updateApp(appId, {
                                columns: columns,
                                data: analysis.rows,
                                googleSheetsLastSynced: new Date().toISOString()
                            });

                            // 現在のアプリ情報も更新
                            if (currentApp) {
                                currentApp.columns = columns;
                                currentApp.data = analysis.rows;
                                currentApp.googleSheetsUrl = sheetUrl;
                            }

                            // データテーブルを更新
                            if (analysis.rows && analysis.rows.length > 0 && columns) {
                                updateAppDataTable(analysis.rows, columns);
                            }

                            showNotification('Googleスプレッドシートと連携しました');
                        }
                    } else {
                        showNotification('スプレッドシートを分析しましたが、アプリが見つかりませんでした', 'warning');
                    }
                } catch (error) {
                    console.error('Error connecting to Google Sheets:', error);
                    alert(`Googleスプレッドシートとの連携に失敗しました。\n\nエラー: ${error.message}\n\n注意: Google API Client Libraryが必要です。`);
                    showNotification('連携に失敗しました', 'error');
                } finally {
                    settingsApiConnectBtn.disabled = false;
                    settingsApiConnectBtn.textContent = originalText;
                }
            });

            // デフォルトで「データ」タブを選択
            setTab('data');
        });
    </script>
</body>
</html>

