<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppNavi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- Firebase設定 -->
    <script src="firebase-config.js"></script>
    <!-- Google Sheets API -->
    <script src="google-sheets-api.js"></script>
</head>
<body class="bg-slate-100 text-slate-900">
    <div id="app-root" class="flex h-screen flex-col">
        <header class="bg-white border-b border-slate-200">
            <div class="mx-auto flex max-w-7xl items-center justify-between px-6 py-4">
                <div class="flex w-72 items-center pl-4">
                    <a id="back-to-dashboard-link" href="index.html" class="mr-3 inline-flex shrink-0 items-center rounded-full border border-slate-200 p-2 text-slate-700 shadow hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m15.75 19.5-7.5-7.5 7.5-7.5" />
                        </svg>
                    </a>
                    <h1 id="view-title" class="text-2xl font-bold text-slate-900">サンプルアプリ</h1>
                    </div>
                <div id="header-controls" class="flex flex-shrink-0 items-center space-x-6">
                    <div id="search-bar" class="relative hidden shrink-0 md:block">
                        <div class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-5 w-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-4.35-4.35M19.125 10.063a6.563 6.563 0 1 1-13.125 0 6.563 6.563 0 0 1 13.125 0Z" />
                            </svg>
                        </div>
                        <input type="search" placeholder="台帳内を検索..." class="w-64 rounded-full border border-slate-200 bg-slate-50 py-2 pl-10 pr-4 text-sm text-slate-700 shadow-inner outline-none focus:border-blue-400 focus:bg-white focus:ring-2 focus:ring-blue-200" />
                    </div>
                    <div id="builder-actions" class="hidden shrink-0 flex items-center space-x-2">
                        <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">プレビュー</button>
                        <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">履歴</button>
                        <button class="rounded-lg bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-green-700">公開</button>
                    </div>
                </div>
            </div>
        </header>
        <div class="flex flex-1 overflow-hidden">
            <!-- 最左縦タブ -->
            <nav class="flex w-16 flex-col border-r border-slate-200 bg-slate-50">
                <button id="tab-data" class="tab-button flex flex-col items-center justify-center border-b border-slate-200 px-3 py-4 text-xs font-semibold text-blue-600 transition-colors hover:bg-white active:bg-blue-50" data-tab="data">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mb-1 h-6 w-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 0 0-1.883 2.542l.857 6a2.25 2.25 0 0 0 2.227 1.932H19.05a2.25 2.25 0 0 0 2.227-1.932l.857-6a2.25 2.25 0 0 0-1.883-2.542m-16.5 0V6A2.25 2.25 0 0 1 6 3.75h3.879a1.5 1.5 0 0 1 1.06.44l2.122 2.12a1.5 1.5 0 0 0 1.06.44H18A2.25 2.25 0 0 1 20.25 9v.776" />
                    </svg>
                    <span>データ</span>
                </button>
                <button id="tab-ui" class="tab-button flex flex-col items-center justify-center border-b border-slate-200 px-3 py-4 text-xs font-semibold text-slate-500 transition-colors hover:bg-white hover:text-blue-600 active:bg-blue-50" data-tab="ui">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mb-1 h-6 w-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.4 2.245 4.5 4.5 0 0 0 8.4-2.245c0-.399-.078-.78-.22-1.128Zm0 0a15.998 15.998 0 0 0 3.388-1.62m-5.043-.025a15.994 15.994 0 0 1 1.622-3.395m3.42 3.42a15.995 15.995 0 0 0 4.764-4.648l3.876-5.814a1.151 1.151 0 0 0-1.597-1.597L14.146 6.32a15.996 15.996 0 0 0-4.649 4.763m3.42 3.42a6.776 6.776 0 0 0-3.42-3.42" />
                    </svg>
                    <span>UI</span>
                </button>
                <button id="tab-chart" class="tab-button flex flex-col items-center justify-center border-b border-slate-200 px-3 py-4 text-xs font-semibold text-slate-500 transition-colors hover:bg-white hover:text-blue-600 active:bg-blue-50" data-tab="chart">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mb-1 h-6 w-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                    </svg>
                    <span>グラフ</span>
                </button>
                <button id="tab-settings" class="tab-button flex flex-col items-center justify-center px-3 py-4 text-xs font-semibold text-slate-500 transition-colors hover:bg-white hover:text-blue-600 active:bg-blue-50" data-tab="settings">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mb-1 h-6 w-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                    <span>設定</span>
                </button>
            </nav>
            <!-- サイドバーコンテンツ（データ） -->
            <aside id="sidebar-data" class="flex w-72 flex-col border-r border-slate-200 bg-white">
                <div class="border-b border-slate-200 px-4 py-4">
                    <button id="data-add-button" class="flex w-full items-center justify-center space-x-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-5 w-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
                        </svg>
                        <span>データを追加</span>
                    </button>
                </div>
                <nav class="flex-1 overflow-auto px-3 py-4 text-sm">
                    <section class="space-y-2">
                        <p class="px-3 text-xs font-semibold uppercase tracking-wide text-slate-400">データテーブル</p>
                        <button id="table-reservations" class="data-table-button flex w-full items-center justify-between rounded-lg bg-blue-50 px-3 py-2 text-blue-700 shadow-sm" data-table="reservations">
                            <span class="font-semibold">施設予約一覧</span>
                            <span class="rounded-full bg-white px-2 py-0.5 text-xs font-semibold text-blue-500">稼働</span>
                        </button>
                    </section>
                </nav>
                <div class="mt-auto border-t border-slate-200 px-4 py-4">
                    <div class="flex items-center justify-center text-sm font-semibold text-slate-600">
                        <span>AppNavi</span>
                    </div>
                </div>
            </aside>
            <!-- サイドバーコンテンツ（UI） -->
            <aside id="sidebar-ui" class="hidden w-72 flex-col border-r border-slate-200 bg-white">
                <div class="border-b border-slate-200 px-4 py-4">
                    <button id="add-page-button" class="flex w-full items-center justify-center space-x-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-5 w-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
                        </svg>
                        <span>ページを追加</span>
                        </button>
                </div>
                <div class="flex-1 overflow-auto px-3 py-4 text-sm">
                    <section class="space-y-2">
                        <div class="flex items-center justify-between px-3 mb-2">
                            <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">ページ構造</p>
                            <span class="text-xs text-slate-400">ドラッグで並び替え</span>
                        </div>
                        <div id="page-list" class="space-y-1">
                            <div class="page-item flex w-full items-center justify-between rounded-lg bg-blue-50 px-3 py-2 text-blue-700 shadow-sm cursor-move" data-page-id="page-1" draggable="true">
                                <span class="font-semibold">予約フォーム</span>
                                <div class="flex items-center space-x-1">
                                    <button class="page-delete rounded p-1 text-slate-400 hover:text-red-600 hover:bg-red-50">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                        </svg>
                        </button>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4 text-slate-400">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                                    </svg>
                                </div>
                            </div>
                            <div class="page-item flex w-full items-center justify-between rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100 cursor-move" data-page-id="page-2" draggable="true">
                                <span>予約カレンダー</span>
                                <div class="flex items-center space-x-1">
                                    <button class="page-delete rounded p-1 text-slate-400 hover:text-red-600 hover:bg-red-50">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                        </svg>
                        </button>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4 text-slate-400">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                                    </svg>
                                </div>
                            </div>
                            <div class="page-item flex w-full items-center justify-between rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100 cursor-move" data-page-id="page-3" draggable="true">
                                <span>承認ダッシュボード</span>
                                <div class="flex items-center space-x-1">
                                    <button class="page-delete rounded p-1 text-slate-400 hover:text-red-600 hover:bg-red-50">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4 text-slate-400">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="mt-6 space-y-2">
                        <p class="px-3 text-xs font-semibold uppercase tracking-wide text-slate-400">コンポーネント</p>
                        <button class="flex w-full items-center rounded-lg border border-dashed border-slate-300 px-3 py-2 text-slate-600 hover:border-blue-400 hover:text-blue-600">
                            <span>入力フィールド</span>
                        </button>
                        <button class="flex w-full items-center rounded-lg border border-dashed border-slate-300 px-3 py-2 text-slate-600 hover:border-blue-400 hover:text-blue-600">
                            <span>ドロップダウン</span>
                        </button>
                        <button class="flex w-full items-center rounded-lg border border-dashed border-slate-300 px-3 py-2 text-slate-600 hover:border-blue-400 hover:text-blue-600">
                            <span>カレンダー</span>
                        </button>
                        <button class="flex w-full items-center rounded-lg border border-dashed border-slate-300 px-3 py-2 text-slate-600 hover:border-blue-400 hover:text-blue-600">
                            <span>メトリクスカード</span>
                        </button>
                        <button class="flex w-full items-center rounded-lg border border-dashed border-slate-300 px-3 py-2 text-slate-600 hover:border-blue-400 hover:text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mr-2 h-4 w-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                            </svg>
                            <span>グラフ</span>
                        </button>
                    </section>
                </div>
                <div class="mt-auto border-t border-slate-200 px-4 py-4">
                    <div class="flex items-center justify-center text-sm font-semibold text-slate-600">
                        <span>AppNavi</span>
                    </div>
                </div>
            </aside>
            <!-- サイドバーコンテンツ（グラフ） -->
            <aside id="sidebar-chart" class="hidden w-72 flex-col border-r border-slate-200 bg-white">
                <div class="flex-1 overflow-auto px-3 py-4 text-sm">
                    <section class="space-y-2">
                        <p class="px-3 text-xs font-semibold uppercase tracking-wide text-slate-400">グラフ設定</p>
                        <div class="px-3 py-2 space-y-3">
                            <div>
                                <label class="text-xs font-semibold text-slate-500 mb-1 block">グラフタイプ</label>
                                <select id="chart-type" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-200">
                                    <option value="bar">棒グラフ</option>
                                    <option value="line">折れ線グラフ</option>
                                    <option value="pie">円グラフ</option>
                                    <option value="doughnut">ドーナツグラフ</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500 mb-1 block">集計方法</label>
                                <select id="chart-group-by" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm text-slate-700 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-200">
                                    <option value="status">ステータス別</option>
                                    <option value="department">申請部署別</option>
                                    <option value="facility">予約施設別</option>
                                    <option value="date">日付別</option>
                                </select>
                            </div>
                        </div>
                    </section>
                    <section class="mt-6 space-y-2">
                        <p class="px-3 text-xs font-semibold uppercase tracking-wide text-slate-400">データテーブル</p>
                        <button class="data-table-button flex w-full items-center justify-between rounded-lg bg-blue-50 px-3 py-2 text-blue-700 shadow-sm" data-table="reservations">
                            <span class="font-semibold">施設予約一覧</span>
                        </button>
                    </section>
                </div>
                <div class="mt-auto border-t border-slate-200 px-4 py-4">
                    <div class="flex items-center justify-center text-sm font-semibold text-slate-600">
                        <span>AppNavi</span>
                    </div>
                </div>
            </aside>
            <!-- サイドバーコンテンツ（設定） -->
            <aside id="sidebar-settings" class="hidden w-72 flex-col border-r border-slate-200 bg-white">
                <div class="flex-1 overflow-auto px-3 py-4 text-sm">
                    <section class="space-y-2">
                        <p class="px-3 text-xs font-semibold uppercase tracking-wide text-slate-400">アプリ設定</p>
                        <button id="settings-btn-general" class="settings-sidebar-btn flex w-full items-center rounded-lg bg-blue-50 px-3 py-2 text-blue-700 shadow-sm" data-settings="general">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mr-2 h-5 w-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.7 2.272a.75.75 0 0 1 .6 0l7.5 3.3a.75.75 0 0 1 .45.689v6.676a3.75 3.75 0 0 1-1.977 3.31l-6.573 3.513a.75.75 0 0 1-.7 0l-6.573-3.513A3.75 3.75 0 0 1 3 12.937V6.261a.75.75 0 0 1 .45-.69l7.5-3.299Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" />
                            </svg>
                            <span>全般設定</span>
                        </button>
                        <button id="settings-btn-api" class="settings-sidebar-btn flex w-full items-center rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100" data-settings="api">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mr-2 h-5 w-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75V11.25m0 1.5v1.5m0-1.5H7.5m1.5 0h1.5M15 12.75V11.25m0 1.5v1.5m0-1.5h-1.5m1.5 0h1.5M4.5 6.75h15m-13.5 0v10.5a2.25 2.25 0 0 0 2.25 2.25h6a2.25 2.25 0 0 0 2.25-2.25V6.75" />
                            </svg>
                            <span>API・連携 (PAI)</span>
                        </button>
                        <button id="settings-btn-ai" class="settings-sidebar-btn flex w-full items-center rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100" data-settings="ai">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mr-2 h-5 w-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6.75 6.75 0 1 0 0-13.5 6.75 6.75 0 0 0 0 13.5Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3l1.5 1.5" />
                            </svg>
                            <span>AI ヘルプ設定</span>
                        </button>
                    </section>
                </div>
                <div class="mt-auto border-t border-slate-200 px-4 py-4">
                    <div class="flex items-center justify-center text-sm font-semibold text-slate-600">
                        <span>AppNavi</span>
                    </div>
                </div>
            </aside>
            <main id="data-view" class="flex-1 overflow-auto px-6 py-6">
                <!-- 初回ガイダンスバナー -->
                <div id="data-onboarding-banner" class="mb-6 rounded-2xl border border-blue-200 bg-gradient-to-r from-blue-50 to-indigo-50 p-6 shadow-sm">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5 text-blue-600">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <h3 class="text-lg font-semibold text-blue-900">データをインポートしました！</h3>
                            </div>
                            <p class="text-sm text-blue-700 mb-4">次に、UIやグラフを作成してアプリを完成させましょう。</p>
                            <div class="grid gap-3 md:grid-cols-2">
                                <div class="rounded-lg border border-blue-200 bg-white p-4">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <div class="flex h-6 w-6 items-center justify-center rounded-full bg-blue-100 text-blue-600 font-bold text-xs">1</div>
                                        <h4 class="text-sm font-semibold text-blue-900">UIタブで入力フォームを作成</h4>
                                    </div>
                                    <p class="text-xs text-blue-700">左側の「UI」タブをクリックして、データ入力用のフォームを作成します。</p>
                                </div>
                                <div class="rounded-lg border border-blue-200 bg-white p-4">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <div class="flex h-6 w-6 items-center justify-center rounded-full bg-blue-100 text-blue-600 font-bold text-xs">2</div>
                                        <h4 class="text-sm font-semibold text-blue-900">グラフタブで可視化</h4>
                                    </div>
                                    <p class="text-xs text-blue-700">左側の「グラフ」タブをクリックして、データをグラフで表示します。</p>
                                </div>
                            </div>
                        </div>
                        <button id="close-data-onboarding" class="ml-4 rounded-lg p-1 text-blue-400 hover:bg-blue-100 hover:text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- テーブル表示 -->
                <div id="table-display-container" class="rounded-2xl border border-slate-200 bg-white shadow-sm">
                    <div id="table-header" class="flex items-center justify-between px-6 py-4">
                        <div>
                            <h2 id="table-title" class="text-xl font-semibold text-slate-900">施設予約一覧</h2>
                            <p id="table-subtitle" class="text-xs text-slate-500">予約マスタ | 最終更新: 2025/11/12 17:45</p>
                        </div>
                        <div id="table-badges" class="flex space-x-2 text-xs">
                            <span class="inline-flex items-center rounded-full bg-amber-100 px-2 py-1 font-medium text-amber-700">承認待ち 3</span>
                            <span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 font-medium text-emerald-700">承認済み 24</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="data-table" class="min-w-full divide-y divide-slate-200 text-sm">
                            <thead id="table-head" class="bg-slate-50 text-slate-500">
                                <tr>
                                    <th class="px-6 py-3 text-left font-semibold">予約ID</th>
                                    <th class="px-6 py-3 text-left font-semibold">予約施設</th>
                                    <th class="px-6 py-3 text-left font-semibold">申請部署</th>
                                    <th class="px-6 py-3 text-left font-semibold">予約者</th>
                                    <th class="px-6 py-3 text-left font-semibold">開始日時</th>
                                    <th class="px-6 py-3 text-left font-semibold">終了時間</th>
                                    <th class="px-6 py-3 text-left font-semibold">ステータス</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-slate-100 bg-white text-slate-700">
                                <!-- テーブルデータがここに動的に挿入されます -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
            <!-- グラフ表示ビュー -->
            <main id="chart-view" class="hidden flex-1 overflow-auto px-6 py-6">
                <div class="space-y-6">
                    <!-- グラフ作成ガイダンス -->
                    <div id="chart-onboarding-banner" class="rounded-2xl border border-green-200 bg-gradient-to-r from-green-50 to-emerald-50 p-6 shadow-sm">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5 text-green-600">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                                    </svg>
                                    <h3 class="text-lg font-semibold text-green-900">グラフの作成</h3>
                                </div>
                                <p class="text-sm text-green-700 mb-4">データをグラフで可視化できます。左側の設定から、グラフの種類や表示方法を変更できます。</p>
                                <div class="grid gap-3 md:grid-cols-2">
                                    <div class="rounded-lg border border-green-200 bg-white p-3">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="text-xs font-bold text-green-600">1.</span>
                                            <span class="text-sm font-semibold text-green-900">グラフタイプを選択</span>
                                        </div>
                                        <p class="text-xs text-green-700 ml-5">左側の「グラフタイプ」から、棒グラフ・折れ線グラフ・円グラフなどを選択</p>
                                    </div>
                                    <div class="rounded-lg border border-green-200 bg-white p-3">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="text-xs font-bold text-green-600">2.</span>
                                            <span class="text-sm font-semibold text-green-900">集計方法を選択</span>
                                        </div>
                                        <p class="text-xs text-green-700 ml-5">左側の「集計方法」から、ステータス別・日付別などでデータを集計</p>
                                    </div>
                                </div>
                                <p class="mt-3 text-xs text-green-600">💡 ヒント: グラフは自動で更新されます。データを追加・編集すると、グラフも自動的に反映されます。</p>
                            </div>
                            <button id="close-chart-onboarding" class="ml-4 rounded-lg p-1 text-green-400 hover:bg-green-100 hover:text-green-600">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                        <div class="mb-4">
                            <h2 class="text-xl font-semibold text-slate-900">データ可視化</h2>
                            <p class="text-xs text-slate-500">施設予約一覧のデータをグラフで表示</p>
                        </div>
                        <div class="h-80">
                            <canvas id="data-chart"></canvas>
                    </div>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                            <h3 class="text-sm font-semibold text-slate-700 mb-4">集計サマリー</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">総予約数</span>
                                    <span class="text-lg font-semibold text-slate-900">27</span>
                            </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">承認済み</span>
                                    <span class="text-lg font-semibold text-emerald-600">24</span>
                        </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">承認待ち</span>
                                    <span class="text-lg font-semibold text-amber-600">3</span>
                                </div>
                        </div>
                    </div>
                        <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                            <h3 class="text-sm font-semibold text-slate-700 mb-4">時系列トレンド</h3>
                            <div class="h-48">
                                <canvas id="trend-chart"></canvas>
                            </div>
                    </div>
                            </div>
                        </div>
            </main>
            <section id="builder-view" class="hidden flex flex-1 overflow-hidden bg-slate-100">
                <div class="flex h-full w-full">
                    <div class="flex-1 overflow-auto bg-slate-50 p-6">
                        <!-- UI作成ガイダンス -->
                        <div id="ui-onboarding-banner" class="mb-6 mx-auto max-w-3xl rounded-2xl border border-purple-200 bg-gradient-to-r from-purple-50 to-pink-50 p-6 shadow-sm">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5 text-purple-600">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.4 2.245 4.5 4.5 0 0 0 8.4-2.245c0-.399-.078-.78-.22-1.128Zm0 0a15.998 15.998 0 0 0 3.388-1.62m-5.043-.025a15.994 15.994 0 0 1 1.622-3.395m3.42 3.42a15.995 15.995 0 0 0 4.764-4.648l3.876-5.814a1.151 1.151 0 0 0-1.597-1.597L14.146 6.32a15.996 15.996 0 0 0-4.649 4.763m3.42 3.42a6.776 6.776 0 0 0-3.42-3.42" />
                                        </svg>
                                        <h3 class="text-lg font-semibold text-purple-900">UI（入力フォーム）の作成</h3>
                                    </div>
                                    <p class="text-sm text-purple-700 mb-4">データ入力用のフォームが自動生成されています。以下の方法でカスタマイズできます。</p>
                                    <div class="space-y-3">
                                        <div class="rounded-lg border border-purple-200 bg-white p-3">
                                            <div class="flex items-center space-x-2 mb-1">
                                                <span class="text-xs font-bold text-purple-600">1.</span>
                                                <span class="text-sm font-semibold text-purple-900">左側の「ページを追加」ボタン</span>
                                            </div>
                                            <p class="text-xs text-purple-700 ml-5">新しいページ（入力フォーム）を追加できます</p>
                                        </div>
                                        <div class="rounded-lg border border-purple-200 bg-white p-3">
                                            <div class="flex items-center space-x-2 mb-1">
                                                <span class="text-xs font-bold text-purple-600">2.</span>
                                                <span class="text-sm font-semibold text-purple-900">コンポーネントをドラッグ&ドロップ</span>
                                            </div>
                                            <p class="text-xs text-purple-700 ml-5">左側の「コンポーネント」から、入力フィールドやボタンを追加できます</p>
                                        </div>
                                        <div class="rounded-lg border border-purple-200 bg-white p-3">
                                            <div class="flex items-center space-x-2 mb-1">
                                                <span class="text-xs font-bold text-purple-600">3.</span>
                                                <span class="text-sm font-semibold text-purple-900">フォームを直接編集</span>
                                            </div>
                                            <p class="text-xs text-purple-700 ml-5">下のフォームをクリックして、項目を編集・削除できます</p>
                                        </div>
                                    </div>
                                </div>
                                <button id="close-ui-onboarding" class="ml-4 rounded-lg p-1 text-purple-400 hover:bg-purple-100 hover:text-purple-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div id="auto-generated-form" class="mx-auto max-w-3xl space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow">
                            <!-- 自動生成フォームがここに表示されます -->
                            <div class="grid grid-cols-2 gap-4" id="default-form">
                                <div>
                                    <label class="text-xs font-semibold text-slate-500">予約施設</label>
                                    <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option>第1会議室 (12名)</option>
                                        <option>第2会議室 (8名)</option>
                                        <option>公用車 (市民課)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-slate-500">利用部署</label>
                                    <input type="text" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" value="税務課" />
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-slate-500">予約者</label>
                                    <input type="text" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" value="佐々木 太郎" />
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-slate-500">連絡先</label>
                                    <input type="tel" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" value="03-1234-5678" />
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-semibold text-slate-500">開始日時</label>
                                    <input type="datetime-local" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" value="2025-11-20T09:00" />
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-slate-500">終了日時</label>
                                    <input type="time" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" value="11:00" />
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500">利用目的</label>
                                <textarea rows="4" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="打合せの内容を入力してください"></textarea>
                            </div>
                            <div class="flex items-center justify-between">
                                <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-500 hover:bg-slate-100">下書き保存</button>
                                <div class="space-x-2">
                                    <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">承認経路を編集</button>
                                    <button class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text白 shadow hover:bg-blue-700">申請を送信</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    <aside id="builder-properties" class="w-80 flex-shrink-0 border-l border-slate-200 bg-white p-4 overflow-auto">
                        <h3 class="text-sm font-semibold text-slate-700">プロパティ</h3>
                        <div class="mt-3 space-y-4 text-sm">
                            <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
                                <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">対象フィールド</p>
                                <p class="mt-1 text-lg font-semibold text-slate-900">予約施設</p>
                                <p class="text-xs text-slate-500">ドロップダウン | 施設マスタ</p>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500">ラベル名</label>
                                <input type="text" value="予約施設" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500">プレースホルダー</label>
                                <input type="text" value="会議室を選択してください" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500">データソース</label>
                                <div class="mt-1 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2">
                                    <p class="text-sm font-semibold text-slate-700">会議室マスタ</p>
                                    <p class="text-xs text-slate-500">フィールド: 施設名 / 定員 / 設備</p>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500">バリデーション</label>
                                <div class="mt-1 space-y-2">
                                    <label class="flex items-center space-x-2 text-slate-600">
                                        <input type="checkbox" checked class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" />
                                        <span>必須入力</span>
                                    </label>
                                    <label class="flex items-center space-x-2 text-slate-600">
                                        <input type="checkbox" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" />
                                        <span>管理者のみ編集可能</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500">アクション</label>
                                <ul class="mt-2 space-y-2 text-xs text-slate-600">
                                    <li>・値変更時に重複予約チェック</li>
                                    <li>・承認ワークフローを更新</li>
                                </ul>
                                <button class="mt-3 w全 rounded-lg border border-dashed border-slate-300 px-4 py-2 text-sm text-slate-500 hover:border-blue-400 hover:text-blue-600">＋ アクションを追加</button>
                            </div>
                        </div>
                    </aside>
                </div>
            </section>
            <!-- 設定表示ビュー -->
            <main id="settings-view" class="hidden flex-1 overflow-auto bg-slate-50">
                <div class="px-6 py-6">
                    <!-- 全般設定 -->
                    <div id="settings-general" class="settings-content rounded-2xl border border-slate-200 bg-white p-6 shadow-sm max-w-4xl">
                        <h2 class="text-xl font-semibold text-slate-900 mb-6">全般設定</h2>
                        <div class="space-y-6">
                            <div>
                                <label class="text-sm font-semibold text-slate-700 mb-2 block">アプリ名</label>
                                <input type="text" id="settings-app-name" class="w-full rounded-lg border border-slate-300 px-4 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="アプリ名を入力" />
                                <p class="mt-1 text-xs text-slate-500">ダッシュボードに表示されるアプリ名です</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700 mb-2 block">説明</label>
                                <textarea id="settings-app-description" rows="3" class="w-full rounded-lg border border-slate-300 px-4 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="アプリの説明を入力"></textarea>
                                <p class="mt-1 text-xs text-slate-500">アプリの用途や目的を簡潔に説明してください</p>
                            </div>
                            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-slate-200">
                                <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100">キャンセル</button>
                                <button id="settings-save-btn" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-700">保存</button>
                            </div>
                        </div>
                    </div>
                <!-- API・連携設定 -->
                <div id="settings-api" class="settings-content hidden rounded-2xl border border-slate-200 bg-white p-6 shadow-sm max-w-4xl">
                        <h2 class="text-xl font-semibold text-slate-900 mb-6">外部サービスとの連携設定</h2>
                        <div class="space-y-6">
                            <div class="rounded-xl border border-blue-100 bg-blue-50 px-4 py-3">
                                <p class="text-sm font-semibold text-blue-900">Googleスプレッドシート連携</p>
                                <p class="mt-1 text-xs text-blue-700">Googleスプレッドシートと連携して、データを自動で更新できます</p>
                                <p class="mt-2 text-xs text-blue-600">📌 使い方: スプレッドシートのURLをコピー&ペーストするだけ。Excelのようにデータを管理できます。</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700 mb-2 block">スプレッドシートURL <span class="text-xs font-normal text-slate-500">(必須)</span></label>
                                <input type="text" id="settings-sheet-url" class="w-full rounded-lg border border-slate-300 px-4 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="https://docs.google.com/spreadsheets/d/..." />
                                <div class="mt-2 rounded-lg border border-amber-100 bg-amber-50 px-3 py-2">
                                    <p class="text-xs font-semibold text-amber-900 mb-1">⚠️ 事前準備が必要です</p>
                                    <ol class="ml-4 list-decimal text-xs text-amber-700 space-y-1">
                                        <li>Googleスプレッドシートを開く</li>
                                        <li>右上の「共有」ボタンをクリック</li>
                                        <li>「リンクを知っている全員」に変更</li>
                                        <li>URLをコピーして、上の入力欄に貼り付け</li>
                                    </ol>
                                </div>
                            </div>
                            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-slate-200">
                                <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100">キャンセル</button>
                                <button class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-700">連携を開始</button>
                            </div>
                        </div>
                    </div>
                <!-- AIヘルプ設定 -->
                <div id="settings-ai" class="settings-content hidden rounded-2xl border border-slate-200 bg-white p-6 shadow-sm max-w-4xl">
                        <h2 class="text-xl font-semibold text-slate-900 mb-6">AI ヘルプ設定</h2>
                        <div class="space-y-6">
                            <div class="rounded-xl border border-amber-100 bg-amber-50 px-4 py-3">
                                <p class="text-sm font-semibold text-amber-900">AIアシスタント機能</p>
                                <p class="mt-1 text-xs text-amber-700">AIが操作をサポートし、質問に答えます</p>
                            </div>
                            <div>
                                <label class="flex items-center space-x-2 text-slate-700">
                                    <input type="checkbox" id="settings-ai-enabled" checked class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" />
                                    <span class="text-sm font-semibold">AIヘルプを有効にする</span>
                                </label>
                                <p class="mt-1 text-xs text-slate-500">AIアシスタントが操作をガイドします</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-700 mb-2 block">ヘルプレベル</label>
                                <select id="settings-ai-level" class="w-full rounded-lg border border-slate-300 px-4 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">
                                    <option value="basic">基本（必要最小限の案内）</option>
                                    <option value="detailed" selected>詳細（詳しい説明とヒント）</option>
                                    <option value="full">完全（すべての操作をガイド）</option>
                                </select>
                            </div>
                            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-slate-200">
                                <button class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100">キャンセル</button>
                                <button class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-700">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="data-add-modal" class="pointer-events-none fixed inset-0 z-40 hidden items-center justify-center bg-slate-900/60 px-4 py-8">
        <div class="pointer-events-auto w-full max-w-3xl rounded-2xl bg-white shadow-2xl">
            <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
                <div>
                    <h3 class="text-lg font-semibold text-slate-900">データを追加</h3>
                    <p class="text-xs text-slate-500" id="modal-table-name">選択したテーブルに新しいデータを追加します。</p>
                </div>
                <button id="data-add-modal-close" class="rounded-full border border-slate-200 p-2 text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="px-6 py-6">
                <div class="space-y-4 text-sm text-slate-600">
                    <div class="rounded-xl border border-blue-100 bg-blue-50 px-5 py-4">
                        <p class="font-semibold text-blue-900">データ追加方法を選択</p>
                        <div class="mt-4 space-y-3">
                            <button class="flex w-full items-center justify-between rounded-lg border border-blue-200 bg-white px-4 py-3 text-sm hover:border-blue-400 hover:bg-blue-50">
                                <span class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-5 w-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
                                    </svg>
                                    <span>手動で入力</span>
                                </span>
                            </button>
                            <button class="flex w-full items-center justify-between rounded-lg border border-blue-200 bg-white px-4 py-3 text-sm hover:border-blue-400 hover:bg-blue-50">
                                <span class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-5 w-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75 9 17.25l10.5-10.5M12 3.75v12" />
                                    </svg>
                                    <span>Excelからインポート</span>
                                </span>
                            </button>
                            <button class="flex w-full items-center justify-between rounded-lg border border-blue-200 bg-white px-4 py-3 text-sm hover:border-blue-400 hover:bg-blue-50">
                                <span class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-5 w-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                    </svg>
                                    <span>CSVからインポート</span>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex items-center justify-end space-x-2">
                    <button id="data-add-modal-cancel" class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // タブ要素
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabData = document.getElementById('tab-data');
            const tabUI = document.getElementById('tab-ui');
            const tabChart = document.getElementById('tab-chart');
            const tabSettings = document.getElementById('tab-settings');
            
            // サイドバー要素
            const sidebarData = document.getElementById('sidebar-data');
            const sidebarUI = document.getElementById('sidebar-ui');
            const sidebarChart = document.getElementById('sidebar-chart');
            const sidebarSettings = document.getElementById('sidebar-settings');
            
            // ビュー要素
            const dataView = document.getElementById('data-view');
            const builderView = document.getElementById('builder-view');
            const chartView = document.getElementById('chart-view');
            const settingsView = document.getElementById('settings-view');
            
            // ヘッダー要素
            const builderActions = document.getElementById('builder-actions');
            const searchBar = document.getElementById('search-bar');
            const backToDashboardLink = document.getElementById('back-to-dashboard-link');
            const viewTitle = document.getElementById('view-title');
            
            // データ追加関連
            const dataAddButton = document.getElementById('data-add-button');
            const dataTableButtons = document.querySelectorAll('.data-table-button');
            const dataAddModal = document.getElementById('data-add-modal');
            const dataAddModalClose = document.getElementById('data-add-modal-close');
            const dataAddModalCancel = document.getElementById('data-add-modal-cancel');
            let selectedTable = null;
            
            // グラフ関連
            let dataChart = null;
            let trendChart = null;
            const chartTypeSelect = document.getElementById('chart-type');
            const chartGroupBySelect = document.getElementById('chart-group-by');

            // オンボーディングバナーの要素
            const closeDataOnboarding = document.getElementById('close-data-onboarding');
            const closeUIOnboarding = document.getElementById('close-ui-onboarding');
            const closeChartOnboarding = document.getElementById('close-chart-onboarding');
            const dataOnboardingBanner = document.getElementById('data-onboarding-banner');
            const uiOnboardingBanner = document.getElementById('ui-onboarding-banner');
            const chartOnboardingBanner = document.getElementById('chart-onboarding-banner');
            
            // 初回表示チェック（URLパラメータでnewApp=trueの場合のみ表示）
            const urlParamsForOnboarding = new URLSearchParams(window.location.search);
            const isNewAppForOnboarding = urlParamsForOnboarding.get('newApp') === 'true';
            const hasSeenDataOnboarding = localStorage.getItem('hasSeenDataOnboarding');
            const hasSeenUIOnboarding = localStorage.getItem('hasSeenUIOnboarding');
            const hasSeenChartOnboarding = localStorage.getItem('hasSeenChartOnboarding');
            
            // オンボーディングバナーの閉じるボタンのイベント
            if (closeDataOnboarding) {
                closeDataOnboarding.addEventListener('click', () => {
                    dataOnboardingBanner?.classList.add('hidden');
                    localStorage.setItem('hasSeenDataOnboarding', 'true');
                });
            }
            
            // UIオンボーディングバナーの閉じるボタン（localStorageに保存して永続化）
            if (closeUIOnboarding) {
                closeUIOnboarding.addEventListener('click', () => {
                    uiOnboardingBanner?.classList.add('hidden');
                    // localStorageに保存（永続的に非表示にする）
                    localStorage.setItem('hasSeenUIOnboarding', 'true');
                });
            }
            
            if (closeChartOnboarding) {
                closeChartOnboarding.addEventListener('click', () => {
                    chartOnboardingBanner?.classList.add('hidden');
                    localStorage.setItem('hasSeenChartOnboarding', 'true');
                });
            }
            
            // 初回表示の制御
            if (isNewAppForOnboarding && !hasSeenDataOnboarding) {
                // 新規アプリ作成時はデータビューのガイダンスを表示
                dataOnboardingBanner?.classList.remove('hidden');
            } else if (hasSeenDataOnboarding) {
                dataOnboardingBanner?.classList.add('hidden');
            }
            
            if (hasSeenUIOnboarding && uiOnboardingBanner) {
                uiOnboardingBanner.classList.add('hidden');
            }
            
            if (hasSeenChartOnboarding && chartOnboardingBanner) {
                chartOnboardingBanner.classList.add('hidden');
            }

            // タブ切り替え関数
            const setTab = (tabName) => {
                // すべてのタブのスタイルをリセット
                tabButtons.forEach(btn => {
                    btn.classList.remove('bg-white', 'text-blue-600');
                    btn.classList.add('text-slate-500');
                });
                
                // すべてのサイドバーを非表示
                sidebarData.classList.add('hidden');
                sidebarUI.classList.add('hidden');
                sidebarChart.classList.add('hidden');
                sidebarSettings.classList.add('hidden');
                
                // すべてのビューを非表示
                dataView.classList.add('hidden');
                builderView.classList.add('hidden');
                chartView.classList.add('hidden');
                settingsView.classList.add('hidden');
                
                // 選択されたタブに応じて表示を切り替え
                if (tabName === 'data') {
                    tabData.classList.remove('text-slate-500');
                    tabData.classList.add('bg-white', 'text-blue-600');
                    sidebarData.classList.remove('hidden');
                    dataView.classList.remove('hidden');
                    builderActions.classList.add('hidden');
                    searchBar.classList.remove('hidden');
                    backToDashboardLink.classList.remove('hidden');
                    viewTitle.textContent = 'サンプルアプリ';
                } else if (tabName === 'ui') {
                    tabUI.classList.remove('text-slate-500');
                    tabUI.classList.add('bg-white', 'text-blue-600');
                    sidebarUI.classList.remove('hidden');
                    builderView.classList.remove('hidden');
                    builderActions.classList.remove('hidden');
                    searchBar.classList.add('hidden');
                    backToDashboardLink.classList.remove('hidden');
                    viewTitle.textContent = 'サンプルアプリ';
                    // UIタブを開くとき、既に閉じられている場合は非表示のままにする
                    if (hasSeenUIOnboarding && uiOnboardingBanner) {
                        uiOnboardingBanner.classList.add('hidden');
                    } else if (!hasSeenUIOnboarding && uiOnboardingBanner) {
                        // 初めて開く場合のみガイダンスを表示
                        uiOnboardingBanner.classList.remove('hidden');
                    }
                } else if (tabName === 'chart') {
                    tabChart.classList.remove('text-slate-500');
                    tabChart.classList.add('bg-white', 'text-blue-600');
                    sidebarChart.classList.remove('hidden');
                    chartView.classList.remove('hidden');
                    builderActions.classList.add('hidden');
                    searchBar.classList.remove('hidden');
                    backToDashboardLink.classList.remove('hidden');
                    viewTitle.textContent = 'グラフ';
                    initCharts();
                    // グラフタブを初めて開く場合、ガイダンスを表示
                    if (!hasSeenChartOnboarding && chartOnboardingBanner) {
                        chartOnboardingBanner.classList.remove('hidden');
                    }
                } else if (tabName === 'settings') {
                    tabSettings.classList.remove('text-slate-500');
                    tabSettings.classList.add('bg-white', 'text-blue-600');
                    sidebarSettings.classList.remove('hidden');
                    settingsView.classList.remove('hidden');
                    builderActions.classList.add('hidden');
                    searchBar.classList.remove('hidden');
                    backToDashboardLink.classList.remove('hidden');
                    viewTitle.textContent = 'アプリ設定';
                    // デフォルトで全般設定を表示
                    showSettingsContent('general');
                }
            };

            // タブボタンのイベントリスナー
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    setTab(tabName);
                });
            });

            // テーブルデータ定義
            const tableData = {
                'reservations': {
                    name: '施設予約一覧',
                    subtitle: '予約マスタ | 最終更新: 2025/11/12 17:45',
                    badges: [
                        { text: '承認待ち 3', class: 'bg-amber-100 text-amber-700' },
                        { text: '承認済み 24', class: 'bg-emerald-100 text-emerald-700' }
                    ],
                    headers: ['予約ID', '予約施設', '申請部署', '予約者', '開始日時', '終了時間', 'ステータス'],
                    rows: [
                        ['R-201', '第1会議室 (12名)', '税務課', '佐々木 太郎', '2025/11/20 09:00', '11:00', '<span class="inline-flex items-center rounded-full bg-amber-100 px-2 py-1 text-xs font-semibold text-amber-700">承認待ち</span>'],
                        ['R-202', '公用車 (市民課)', '市民課', '山本 花子', '2025/11/21 13:00', '16:00', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">承認済</span>'],
                        ['R-203', '大会議室 (30名)', '企画課', '井上 修', '2025/11/22 15:00', '18:00', '<span class="inline-flex items-center rounded-full bg-sky-100 px-2 py-1 text-xs font-semibold text-sky-700">申請中</span>']
                    ]
                },
                'equipment': {
                    name: '備品管理台帳',
                    subtitle: '備品マスタ | 最終更新: 2025/11/12 17:45',
                    badges: [
                        { text: '総数 45', class: 'bg-blue-100 text-blue-700' },
                        { text: '貸出中 12', class: 'bg-violet-100 text-violet-700' }
                    ],
                    headers: ['備品ID', '備品名', 'カテゴリ', '保管場所', '状態', '貸出状況', '最終更新日'],
                    rows: [
                        ['E-001', 'ノートPC (ThinkPad)', 'PC機器', '2階倉庫', '良好', '貸出中', '2025/11/10'],
                        ['E-002', 'プロジェクター EPSON', 'AV機器', '3階倉庫', '良好', '利用可能', '2025/11/08'],
                        ['E-003', 'ホワイトボード 180cm', '事務用品', '第1会議室', '良好', '貸出中', '2025/11/05'],
                        ['E-004', 'コピー機 複合機', '事務機器', '1階オフィス', 'メンテ中', '利用不可', '2025/11/12'],
                        ['E-005', 'モニター 27インチ', 'PC機器', '2階倉庫', '良好', '利用可能', '2025/11/09']
                    ]
                },
                'users': {
                    name: '利用者マスタ',
                    subtitle: 'ユーザーマスタ | 最終更新: 2025/11/12 17:45',
                    badges: [
                        { text: '総数 156', class: 'bg-blue-100 text-blue-700' },
                        { text: '有効 148', class: 'bg-emerald-100 text-emerald-700' }
                    ],
                    headers: ['ユーザーID', '氏名', '所属部署', 'メールアドレス', '権限', '最終ログイン', 'ステータス'],
                    rows: [
                        ['U-001', '田中 一郎', '総務課', 'tanaka@city.example.jp', '一般', '2025/11/12 09:30', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">有効</span>'],
                        ['U-002', '鈴木 花子', '市民課', 'suzuki@city.example.jp', '管理者', '2025/11/12 10:15', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">有効</span>'],
                        ['U-003', '佐藤 太郎', '税務課', 'sato@city.example.jp', '一般', '2025/11/11 16:45', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">有効</span>'],
                        ['U-004', '高橋 美咲', '企画課', 'takahashi@city.example.jp', '一般', '2025/11/10 14:20', '<span class="inline-flex items-center rounded-full bg-amber-100 px-2 py-1 text-xs font-semibold text-amber-700">一時停止</span>'],
                        ['U-005', '伊藤 健太', '環境課', 'ito@city.example.jp', '一般', '2025/11/12 11:00', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">有効</span>']
                    ]
                },
                'rooms': {
                    name: '会議室マスタ',
                    subtitle: '施設マスタ | 最終更新: 2025/11/12 17:45',
                    badges: [
                        { text: '総数 8', class: 'bg-blue-100 text-blue-700' },
                        { text: '利用可能 5', class: 'bg-emerald-100 text-emerald-700' }
                    ],
                    headers: ['施設ID', '施設名', '定員', '設備', '所在地', '予約可能時間', '状態'],
                    rows: [
                        ['R-101', '第1会議室', '12名', 'プロジェクター、ホワイトボード', '本庁舎2階', '平日 9:00-18:00', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">利用可能</span>'],
                        ['R-102', '第2会議室', '8名', 'ホワイトボード', '本庁舎2階', '平日 9:00-18:00', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">利用可能</span>'],
                        ['R-103', '大会議室', '30名', 'プロジェクター、音響設備', '本庁舎3階', '平日 9:00-18:00', '<span class="inline-flex items-center rounded-full bg-amber-100 px-2 py-1 text-xs font-semibold text-amber-700">メンテナンス中</span>'],
                        ['R-201', '公用車 (市民課)', '7名', 'ETC、カーナビ', '駐車場A', '平日 8:00-20:00', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">利用可能</span>'],
                        ['R-202', '公用車 (総務課)', '5名', 'ETC、カーナビ', '駐車場A', '平日 8:00-20:00', '<span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">利用可能</span>']
                    ]
                }
            };

            // テーブル表示更新関数
            function updateTableDisplay(tableKey) {
                const data = tableData[tableKey];
                if (!data) return;

                const tableTitle = document.getElementById('table-title');
                const tableSubtitle = document.getElementById('table-subtitle');
                const tableBadges = document.getElementById('table-badges');
                const tableHead = document.getElementById('table-head');
                const tableBody = document.getElementById('table-body');

                if (tableTitle) tableTitle.textContent = data.name;
                if (tableSubtitle) tableSubtitle.textContent = data.subtitle;

                // バッジ更新
                if (tableBadges) {
                    tableBadges.innerHTML = data.badges.map(badge => 
                        `<span class="inline-flex items-center rounded-full px-2 py-1 font-medium ${badge.class}">${badge.text}</span>`
                    ).join('');
                }

                // ヘッダー更新
                if (tableHead) {
                    const headerRow = tableHead.querySelector('tr');
                    if (headerRow) {
                        headerRow.innerHTML = data.headers.map(header => 
                            `<th class="px-6 py-3 text-left font-semibold">${header}</th>`
                        ).join('');
                    }
                }

                // ヘッダーに「操作」列を追加
                if (tableHead) {
                    const headerRow = tableHead.querySelector('tr');
                    if (headerRow && !headerRow.querySelector('th:last-child')?.textContent.includes('操作')) {
                        headerRow.innerHTML += '<th class="px-6 py-3 text-left font-semibold">操作</th>';
                    }
                }
                
                // ボディ更新（編集・削除ボタン付き）
                if (tableBody) {
                    tableBody.innerHTML = data.rows.map((row, index) => {
                        const firstCell = row[0];
                        const isLink = firstCell.startsWith('R-') || firstCell.startsWith('E-') || firstCell.startsWith('U-');
                        const firstCellHTML = isLink ? `<td class="px-6 py-4 font-semibold text-blue-600">${firstCell}</td>` : `<td class="px-6 py-4 font-semibold text-blue-600">${firstCell}</td>`;
                        const rowId = firstCell || `row-${index}`;
                        
                        return `<tr class="hover:bg-slate-50" data-row-id="${rowId}">
                            ${firstCellHTML}
                            ${row.slice(1).map(cell => `<td class="px-6 py-4">${cell}</td>`).join('')}
                            ${getActionButtonsHTML(rowId)}
                        </tr>`;
                    }).join('');
                    
                    // イベントリスナーを追加（サンプルデータ用）
                    tableBody.querySelectorAll('.edit-row-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showNotification('サンプルデータは編集できません。実際のアプリデータを編集してください。', 'info');
                        });
                    });
                    
                    tableBody.querySelectorAll('.delete-row-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showNotification('サンプルデータは削除できません。実際のアプリデータを削除してください。', 'info');
                        });
                    });
                }

                // ヘッダータイトルも更新
                if (viewTitle) {
                    viewTitle.textContent = data.name;
                }
            }

            const tableNames = {
                'reservations': '施設予約一覧',
                'equipment': '備品管理台帳',
                'users': '利用者マスタ',
                'rooms': '会議室マスタ'
            };

            dataTableButtons.forEach(button => {
                button.addEventListener('click', () => {
                    dataTableButtons.forEach(b => {
                        b.classList.remove('bg-blue-50', 'text-blue-700', 'shadow-sm');
                        b.classList.add('text-slate-600');
                    });
                    button.classList.add('bg-blue-50', 'text-blue-700', 'shadow-sm');
                    button.classList.remove('text-slate-600');
                    selectedTable = button.dataset.table;
                    
                    // テーブル表示を更新
                    updateTableDisplay(selectedTable);
                    
                    const modalTableName = document.getElementById('modal-table-name');
                    if (modalTableName && tableNames[selectedTable]) {
                        modalTableName.textContent = `${tableNames[selectedTable]}に新しいデータを追加します。`;
                    }
                });
            });

            const openDataAddModal = () => {
                if (!selectedTable) {
                    alert('データテーブルを選択してください');
                    return;
                }
                if (dataAddModal) {
                    dataAddModal.classList.remove('hidden');
                    dataAddModal.classList.add('flex');
                }
            };

            const closeDataAddModal = () => {
                if (dataAddModal) {
                    dataAddModal.classList.remove('flex');
                    dataAddModal.classList.add('hidden');
                }
            };

            if (dataAddButton) {
                dataAddButton.addEventListener('click', openDataAddModal);
            }
            if (dataAddModalClose) {
                dataAddModalClose.addEventListener('click', closeDataAddModal);
            }
            if (dataAddModalCancel) {
                dataAddModalCancel.addEventListener('click', closeDataAddModal);
            }
            if (dataAddModal) {
                dataAddModal.addEventListener('click', (event) => {
                    if (event.target === dataAddModal) {
                        closeDataAddModal();
                    }
                });
            }

            // 初期テーブル表示
            if (dataTableButtons.length > 0) {
                selectedTable = dataTableButtons[0].dataset.table;
                updateTableDisplay(selectedTable);
                dataTableButtons[0].click();
            }

            // グラフ初期化関数（実際のデータから生成）
            const initCharts = () => {
                const chartCtx = document.getElementById('data-chart');
                const trendCtx = document.getElementById('trend-chart');
                
                if (!chartCtx || !trendCtx) return;

                // 既存のグラフを破棄
                if (dataChart) {
                    dataChart.destroy();
                }
                if (trendChart) {
                    trendChart.destroy();
                }

                // 実際のアプリデータからグラフデータを生成
                let chartData = null;
                let trendData = null;

                if (currentApp && currentApp.data && currentApp.data.length > 0 && currentApp.columns) {
                    const groupBy = chartGroupBySelect.value;
                    const chartType = chartTypeSelect.value;
                    
                    // データから集計
                    chartData = generateChartDataFromAppData(currentApp.data, currentApp.columns, groupBy);
                    trendData = generateTrendDataFromAppData(currentApp.data, currentApp.columns);
                } else {
                    // フォールバック: サンプルデータ
                    const sampleData = {
                        status: {
                            labels: ['承認済み', '承認待ち', '申請中'],
                            data: [24, 3, 1]
                        },
                        department: {
                            labels: ['税務課', '市民課', '企画課'],
                            data: [10, 12, 5]
                        },
                        facility: {
                            labels: ['第1会議室', '公用車', '大会議室'],
                            data: [15, 8, 4]
                        },
                        date: {
                            labels: ['11/20', '11/21', '11/22', '11/23', '11/24'],
                            data: [5, 8, 6, 4, 4]
                        }
                    };
                    chartData = sampleData[chartGroupBySelect.value] || sampleData.status;
                    trendData = {
                        labels: ['11/20', '11/21', '11/22', '11/23', '11/24', '11/25'],
                        data: [5, 8, 6, 4, 4, 7]
                    };
                }

                const data = chartData;

                // メイングラフ
                dataChart = new Chart(chartCtx, {
                    type: chartType === 'doughnut' ? 'doughnut' : chartType === 'pie' ? 'pie' : chartType === 'line' ? 'line' : 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: '件数',
                            data: data.data,
                            backgroundColor: chartType === 'pie' || chartType === 'doughnut' 
                                ? ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                                : '#3b82f6',
                            borderColor: '#1e40af',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false
                            }
                        }
                    }
                });

                // 時系列トレンドグラフ
                trendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: trendData.labels,
                        datasets: [{
                            label: trendData.label || '件数',
                            data: trendData.data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            };

            // アプリデータからグラフデータを生成（営業戦略レポート用）
            function generateChartDataFromAppData(data, columns, groupBy) {
                if (!data || data.length === 0) {
                    return { labels: [], data: [] };
                }

                // 訪問管理記録でよく使われる列名のパターン
                const dateColumnPatterns = ['日時', '日付', '訪問日', '訪問日時', 'date', 'datetime', '訪問日付', '実施日'];
                const personColumnPatterns = ['担当者', '営業担当', '担当', 'person', 'owner', 'salesperson'];
                const customerColumnPatterns = ['顧客名', '顧客', '会社名', '企業名', 'customer', 'company', 'client'];
                const resultColumnPatterns = ['結果', '訪問結果', 'ステータス', '状態', 'status', 'result', '成約', '商談結果'];
                const purposeColumnPatterns = ['訪問目的', '目的', 'purpose', '目的', '訪問内容'];

                // グループ化する列を特定
                let groupColumn = null;
                const groupByLower = groupBy.toLowerCase();

                if (groupByLower.includes('date') || groupByLower.includes('日')) {
                    groupColumn = columns.find(col => 
                        dateColumnPatterns.some(pattern => col.name.includes(pattern))
                    );
                } else if (groupByLower.includes('person') || groupByLower.includes('担当')) {
                    groupColumn = columns.find(col => 
                        personColumnPatterns.some(pattern => col.name.includes(pattern))
                    );
                } else if (groupByLower.includes('customer') || groupByLower.includes('顧客')) {
                    groupColumn = columns.find(col => 
                        customerColumnPatterns.some(pattern => col.name.includes(pattern))
                    );
                } else if (groupByLower.includes('result') || groupByLower.includes('結果') || groupByLower.includes('status') || groupByLower.includes('ステータス')) {
                    groupColumn = columns.find(col => 
                        resultColumnPatterns.some(pattern => col.name.includes(pattern))
                    );
                } else if (groupByLower.includes('purpose') || groupByLower.includes('目的')) {
                    groupColumn = columns.find(col => 
                        purposeColumnPatterns.some(pattern => col.name.includes(pattern))
                    );
                } else {
                    // デフォルト: 最初のselect型またはtext型の列
                    groupColumn = columns.find(col => 
                        col.type === 'select' || col.type === 'text'
                    ) || columns[0];
                }

                if (!groupColumn) {
                    return { labels: ['データなし'], data: [0] };
                }

                // データを集計
                const counts = {};
                data.forEach(row => {
                    const value = String(row[groupColumn.name] || '').trim();
                    if (value) {
                        counts[value] = (counts[value] || 0) + 1;
                    }
                });

                // ラベルとデータをソート（件数の多い順）
                const sortedEntries = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                const labels = sortedEntries.map(([key]) => key);
                const values = sortedEntries.map(([, value]) => value);

                return { labels, data: values };
            }

            // 時系列トレンドデータを生成（訪問管理記録用）
            function generateTrendDataFromAppData(data, columns) {
                if (!data || data.length === 0) {
                    return { labels: [], data: [], label: '件数' };
                }

                // 日付列を特定
                const dateColumnPatterns = ['日時', '日付', '訪問日', '訪問日時', 'date', 'datetime', '訪問日付', '実施日'];
                const dateColumn = columns.find(col => 
                    dateColumnPatterns.some(pattern => col.name.includes(pattern))
                );

                if (!dateColumn) {
                    // 日付列がない場合は、データ件数を時系列で表示
                    return { labels: ['データ'], data: [data.length], label: '総件数' };
                }

                // 日付ごとに集計
                const dateCounts = {};
                data.forEach(row => {
                    const dateValue = String(row[dateColumn.name] || '').trim();
                    if (dateValue) {
                        // 日付を正規化（YYYY-MM-DD形式に変換を試みる）
                        let normalizedDate = dateValue;
                        try {
                            const date = new Date(dateValue);
                            if (!isNaN(date.getTime())) {
                                normalizedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                            }
                        } catch (e) {
                            // 日付パースに失敗した場合は元の値を使用
                        }
                        dateCounts[normalizedDate] = (dateCounts[normalizedDate] || 0) + 1;
                    }
                });

                // 日付順にソート
                const sortedEntries = Object.entries(dateCounts).sort((a, b) => {
                    return a[0].localeCompare(b[0]);
                });

                // 直近30日分または全データを表示
                const displayEntries = sortedEntries.slice(-30);
                const labels = displayEntries.map(([date]) => {
                    // 日付を短縮形式に変換
                    try {
                        const d = new Date(date);
                        return `${d.getMonth() + 1}/${d.getDate()}`;
                    } catch (e) {
                        return date;
                    }
                });
                const values = displayEntries.map(([, count]) => count);

                return { labels, data: values, label: '訪問件数' };
            }

            // グラフタイプ・集計方法変更時のイベント
            if (chartTypeSelect) {
                chartTypeSelect.addEventListener('change', () => {
                    if (!chartView.classList.contains('hidden')) {
                        initCharts();
                    }
                });
            }

            if (chartGroupBySelect) {
                chartGroupBySelect.addEventListener('change', () => {
                    if (!chartView.classList.contains('hidden')) {
                        initCharts();
                    }
                });
            }

            // アプリ管理機能（Firebase/Supabase構造を参考）
            let currentApp = null;
            let currentFormData = null;
            let selectedFieldIndex = null;

            // URLパラメータからアプリIDを取得
            const urlParams = new URLSearchParams(window.location.search);
            const appId = urlParams.get('appId');
            const isNewApp = urlParams.get('newApp') === 'true';

            // アプリデータを読み込む
            async function loadApp(appId) {
                try {
                    // データベースサービスが初期化されるまで待つ
                    await databaseService.init();
                    
                    // Firestoreからアプリデータを取得
                    const app = await databaseService.getApp(appId);
                    
                    if (app) {
                        // createdAt/updatedAtがTimestampの場合は変換
                        currentApp = {
                            ...app,
                            createdAt: app.createdAt?.toDate ? app.createdAt.toDate().toISOString() : app.createdAt,
                            updatedAt: app.updatedAt?.toDate ? app.updatedAt.toDate().toISOString() : app.updatedAt
                        };
                        
                        if (viewTitle) {
                            viewTitle.textContent = currentApp.name || 'サンプルアプリ';
                        }
                        // ブラウザタブのタイトルも更新
                        document.title = (currentApp.name || 'サンプルアプリ') + ' - AppNavi';
                        
                        // アプリデータを使用してフォームを生成
                        if (currentApp.columns && currentApp.columns.length > 0) {
                            currentFormData = {
                                name: currentApp.name,
                                columns: currentApp.columns,
                                data: currentApp.data || []
                            };
                            // データタブでデータを表示
                            if (currentApp.data && currentApp.data.length > 0 && currentApp.columns) {
                                updateAppDataTable(currentApp.data, currentApp.columns);
                                // グラフの集計方法を動的に更新
                                updateChartGroupByOptions(currentApp.columns);
                                // グラフを更新
                                if (!chartView.classList.contains('hidden')) {
                                    initCharts();
                                }
                            }
                        }
                    } else {
                        console.error('App not found:', appId);
                        if (viewTitle) {
                            viewTitle.textContent = 'アプリが見つかりません';
                        }
                        // ブラウザタブのタイトルも更新
                        document.title = 'アプリが見つかりません - AppNavi';
                    }
                } catch (error) {
                    console.error('Error loading app:', error);
                    // フォールバック: localStorageから読み込み
                    const savedApps = localStorage.getItem('apps');
                    if (savedApps) {
                        const apps = JSON.parse(savedApps);
                        currentApp = apps.find(app => app.id === appId);
                        if (currentApp) {
                            if (viewTitle) {
                                viewTitle.textContent = currentApp.name || 'サンプルアプリ';
                            }
                            // ブラウザタブのタイトルも更新
                            document.title = (currentApp.name || 'サンプルアプリ') + ' - AppNavi';
                            if (currentApp.columns && currentApp.columns.length > 0) {
                                currentFormData = {
                                    name: currentApp.name,
                                    columns: currentApp.columns,
                                    data: currentApp.data || []
                                };
                                if (currentApp.data && currentApp.data.length > 0 && currentApp.columns) {
                                    updateAppDataTable(currentApp.data, currentApp.columns);
                                    // グラフの集計方法を動的に更新
                                    updateChartGroupByOptions(currentApp.columns);
                                    // グラフを更新
                                    if (!chartView.classList.contains('hidden')) {
                                        initCharts();
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // グラフの集計方法の選択肢を動的に更新
            function updateChartGroupByOptions(columns) {
                if (!chartGroupBySelect || !columns) return;

                // 訪問管理記録でよく使われる列名のパターン
                const dateColumnPatterns = ['日時', '日付', '訪問日', '訪問日時', 'date', 'datetime', '訪問日付', '実施日'];
                const personColumnPatterns = ['担当者', '営業担当', '担当', 'person', 'owner', 'salesperson'];
                const customerColumnPatterns = ['顧客名', '顧客', '会社名', '企業名', 'customer', 'company', 'client'];
                const resultColumnPatterns = ['結果', '訪問結果', 'ステータス', '状態', 'status', 'result', '成約', '商談結果'];
                const purposeColumnPatterns = ['訪問目的', '目的', 'purpose', '目的', '訪問内容'];

                // 列を分類
                const dateColumn = columns.find(col => 
                    dateColumnPatterns.some(pattern => col.name.includes(pattern))
                );
                const personColumn = columns.find(col => 
                    personColumnPatterns.some(pattern => col.name.includes(pattern))
                );
                const customerColumn = columns.find(col => 
                    customerColumnPatterns.some(pattern => col.name.includes(pattern))
                );
                const resultColumn = columns.find(col => 
                    resultColumnPatterns.some(pattern => col.name.includes(pattern))
                );
                const purposeColumn = columns.find(col => 
                    purposeColumnPatterns.some(pattern => col.name.includes(pattern))
                );

                // 選択肢を生成
                const options = [];
                if (dateColumn) {
                    options.push({ value: 'date', label: '日付別', column: dateColumn });
                }
                if (personColumn) {
                    options.push({ value: 'person', label: '担当者別', column: personColumn });
                }
                if (customerColumn) {
                    options.push({ value: 'customer', label: '顧客別', column: customerColumn });
                }
                if (resultColumn) {
                    options.push({ value: 'result', label: '結果別', column: resultColumn });
                }
                if (purposeColumn) {
                    options.push({ value: 'purpose', label: '目的別', column: purposeColumn });
                }

                // デフォルトオプションを追加（select型の列）
                columns.forEach(col => {
                    if (col.type === 'select' && !options.find(opt => opt.column.name === col.name)) {
                        options.push({ value: col.name.toLowerCase().replace(/\s+/g, '-'), label: `${col.name}別`, column: col });
                    }
                });

                // 選択肢が1つもない場合は、最初の列を使用
                if (options.length === 0 && columns.length > 0) {
                    options.push({ value: columns[0].name.toLowerCase().replace(/\s+/g, '-'), label: `${columns[0].name}別`, column: columns[0] });
                }

                // select要素を更新
                chartGroupBySelect.innerHTML = options.map(opt => 
                    `<option value="${opt.value}">${opt.label}</option>`
                ).join('');

                // デフォルト選択を設定
                if (options.length > 0) {
                    chartGroupBySelect.value = options[0].value;
                }
            }

            // アプリデータをテーブルに表示
            function updateAppDataTable(data, columns) {
                if (!data || !columns || data.length === 0) return;

                const tableTitle = document.getElementById('table-title');
                const tableSubtitle = document.getElementById('table-subtitle');
                const tableBadges = document.getElementById('table-badges');
                const tableHead = document.getElementById('table-head');
                const tableBody = document.getElementById('table-body');

                // テーブルタイトルを更新
                if (tableTitle && currentApp) {
                    tableTitle.textContent = currentApp.name || 'データ一覧';
                }
                if (tableSubtitle) {
                    const now = new Date();
                    tableSubtitle.textContent = `データマスタ | 最終更新: ${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                }

                // バッジを更新
                if (tableBadges) {
                    tableBadges.innerHTML = `
                        <span class="inline-flex items-center rounded-full bg-blue-100 px-2 py-1 font-medium text-blue-700">総数 ${data.length}</span>
                    `;
                }

                // ヘッダーを更新（カラム名を使用）
                if (tableHead) {
                    const headerRow = tableHead.querySelector('tr');
                    if (headerRow) {
                        headerRow.innerHTML = columns.map(col => 
                            `<th class="px-6 py-3 text-left font-semibold">${col.name}</th>`
                        ).join('');
                    }
                }

                // ボディを更新（編集・削除ボタン付き）
                if (tableBody) {
                    tableBody.innerHTML = data.map((row, index) => {
                        const cells = columns.map(col => {
                            const value = row[col.name] || '';
                            return `<td class="px-6 py-4">${value}</td>`;
                        });
                        const rowId = row[columns[0]?.name] || `row-${index}`;
                        return `<tr class="hover:bg-slate-50" data-row-id="${rowId}">
                            ${cells.join('')}
                            ${getActionButtonsHTML(rowId)}
                        </tr>`;
                    }).join('');
                    
                    // イベントリスナーを追加
                    tableBody.querySelectorAll('.edit-row-btn').forEach((btn, index) => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            editDataRow(index, data[index], columns);
                        });
                    });
                    
                    tableBody.querySelectorAll('.delete-row-btn').forEach((btn, index) => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteDataRow(index, data[index]);
                        });
                    });
                }
            }

            // 新規アプリ作成時はフォームを自動生成
            if (isNewApp) {
                const newAppDataStr = sessionStorage.getItem('newAppData');
                if (newAppDataStr) {
                    const newAppData = JSON.parse(newAppDataStr);
                    currentFormData = newAppData;
                    
                    // アプリ名を更新
                    viewTitle.textContent = newAppData.name || '新しいアプリ';
                    // ブラウザタブのタイトルも更新
                    document.title = (newAppData.name || '新しいアプリ') + ' - AppNavi';
                    
                    // フォームを自動生成
                    generateForm(newAppData.columns);
                    
                    // UIタブを選択
                    setTimeout(() => {
                        setTab('ui');
                        // 通知表示
                        showNotification('フォームが自動生成されました。各フィールドをクリックして編集できます。');
                    }, 100);
                    
                    // sessionStorageをクリア
                    sessionStorage.removeItem('newAppData');
                }
            } else if (appId) {
                // 既存のアプリを読み込む（非同期）
                loadApp(appId).then(() => {
                    // アプリ読み込み後に設定フォームを更新
                    updateSettingsForm();
                }).catch(error => {
                    console.error('Error loading app:', error);
                    if (viewTitle) {
                        viewTitle.textContent = 'アプリの読み込みに失敗しました';
                    }
                    // ブラウザタブのタイトルも更新
                    document.title = 'アプリの読み込みに失敗しました - AppNavi';
                });
            } else {
                // アプリIDがない場合はサンプルアプリを表示
                if (viewTitle) {
                    viewTitle.textContent = 'サンプルアプリ';
                }
                // ブラウザタブのタイトルも更新
                document.title = 'サンプルアプリ - AppNavi';
            }

            // フォーム生成関数
            function generateForm(columns) {
                if (!columns || columns.length === 0) return;

                const formContainer = document.getElementById('auto-generated-form');
                const defaultForm = document.getElementById('default-form');
                
                // デフォルトフォームを非表示
                if (defaultForm) {
                    defaultForm.classList.add('hidden');
                }

                // フォーム要素を生成
                let formHTML = '<div class="space-y-6">';
                
                // 2列グリッドで表示
                const gridItems = [];
                
                columns.forEach((col, index) => {
                    const fieldHTML = generateFieldHTML(col, index);
                    gridItems.push(fieldHTML);
                });

                // 2列に分割
                for (let i = 0; i < gridItems.length; i += 2) {
                    formHTML += '<div class="grid grid-cols-2 gap-4">';
                    formHTML += gridItems[i];
                    if (i + 1 < gridItems.length) {
                        formHTML += gridItems[i + 1];
                    } else {
                        formHTML += '<div></div>'; // 空のセル
                    }
                    formHTML += '</div>';
                }

                // 送信ボタン
                formHTML += `
                    <div class="flex items-center justify-end space-x-2 pt-4 border-t border-slate-200">
                        <button type="button" class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">キャンセル</button>
                        <button type="button" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-700">保存</button>
                    </div>
                `;

                formHTML += '</div>';
                
                // 既存のフォームを置き換え
                const existingForm = formContainer.querySelector('.generated-form-content');
                if (existingForm) {
                    existingForm.innerHTML = formHTML;
                } else {
                    const formContent = document.createElement('div');
                    formContent.className = 'generated-form-content';
                    formContent.innerHTML = formHTML;
                    formContainer.insertBefore(formContent, defaultForm);
                    
                    // フィールドクリックイベントを設定
                    setTimeout(() => {
                        setupFieldClickEvents();
                    }, 100);
                }
            }

            // フィールドHTML生成関数
            function generateFieldHTML(column, index) {
                const label = column.name;
                const type = column.type || 'text';
                const required = column.required ? '<span class="text-red-500">*</span>' : '';
                const fieldId = `field-${index}`;
                
                let inputHTML = '';
                
                switch (type) {
                    case 'select':
                        const options = column.options || [];
                        inputHTML = `
                            <select id="${fieldId}" class="form-field mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" data-field-index="${index}">
                                <option value="">選択してください</option>
                                ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        `;
                        break;
                    
                    case 'date':
                        inputHTML = `
                            <input type="date" id="${fieldId}" class="form-field mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" data-field-index="${index}" />
                        `;
                        break;
                    
                    case 'datetime':
                        inputHTML = `
                            <input type="datetime-local" id="${fieldId}" class="form-field mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" data-field-index="${index}" />
                        `;
                        break;
                    
                    case 'number':
                        inputHTML = `
                            <input type="number" id="${fieldId}" class="form-field mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" data-field-index="${index}" />
                        `;
                        break;
                    
                    default: // text
                        inputHTML = `
                            <input type="text" id="${fieldId}" class="form-field mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" data-field-index="${index}" placeholder="${label}を入力" />
                        `;
                }
                
                return `
                    <div class="form-field-wrapper" data-field-index="${index}">
                        <label class="text-xs font-semibold text-slate-500">
                            ${label} ${required}
                        </label>
                        ${inputHTML}
                    </div>
                `;
            }

            // フィールドクリックイベント設定
            function setupFieldClickEvents() {
                const fieldWrappers = document.querySelectorAll('.form-field-wrapper');
                fieldWrappers.forEach(wrapper => {
                    wrapper.addEventListener('click', (e) => {
                        const fieldIndex = parseInt(wrapper.dataset.fieldIndex);
                        if (currentFormData && currentFormData.columns[fieldIndex]) {
                            selectedFieldIndex = fieldIndex;
                            showFieldProperties(currentFormData.columns[fieldIndex]);
                            
                            // 選択状態を表示
                            fieldWrappers.forEach(w => w.classList.remove('ring-2', 'ring-blue-500', 'rounded-lg'));
                            wrapper.classList.add('ring-2', 'ring-blue-500', 'rounded-lg', 'p-2');
                        }
                    });
                });
            }

            // フィールドプロパティ表示
            function showFieldProperties(column) {
                const propertiesPanel = document.getElementById('builder-properties');
                if (!propertiesPanel) return;

                const typeLabels = {
                    'text': 'テキスト',
                    'number': '数値',
                    'date': '日付',
                    'datetime': '日時',
                    'select': '選択肢'
                };

                propertiesPanel.innerHTML = `
                    <h3 class="text-sm font-semibold text-slate-700 mb-4">プロパティ</h3>
                    <div class="space-y-4 text-sm">
                        <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
                            <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">対象フィールド</p>
                            <p class="mt-1 text-lg font-semibold text-slate-900">${column.name}</p>
                            <p class="text-xs text-slate-500">${typeLabels[column.type] || 'テキスト'}</p>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500">ラベル名</label>
                            <input type="text" value="${column.name}" class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500">フィールドタイプ</label>
                            <select class="mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <option value="text" ${column.type === 'text' ? 'selected' : ''}>テキスト</option>
                                <option value="number" ${column.type === 'number' ? 'selected' : ''}>数値</option>
                                <option value="date" ${column.type === 'date' ? 'selected' : ''}>日付</option>
                                <option value="datetime" ${column.type === 'datetime' ? 'selected' : ''}>日時</option>
                                <option value="select" ${column.type === 'select' ? 'selected' : ''}>選択肢</option>
                            </select>
                        </div>
                        <div>
                            <label class="flex items-center space-x-2 text-slate-600">
                                <input type="checkbox" ${column.required ? 'checked' : ''} class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" />
                                <span>必須入力</span>
                            </label>
                        </div>
                        ${column.type === 'select' && column.options ? `
                            <div>
                                <label class="text-xs font-semibold text-slate-500">選択肢</label>
                                <div class="mt-1 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 max-h-32 overflow-y-auto">
                                    ${column.options.map(opt => `<p class="text-xs text-slate-600">${opt}</p>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // 通知表示関数
            function showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 z-50 rounded-lg bg-blue-600 px-4 py-3 text-sm text-white shadow-lg';
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            // ページ管理機能
            let pageCounter = 4; // 既存の3ページ + 1
            let selectedPageId = 'page-1';
            let draggedElement = null;

            const addPageButton = document.getElementById('add-page-button');
            const pageList = document.getElementById('page-list');

            // ページ追加機能
            addPageButton?.addEventListener('click', () => {
                const pageId = `page-${pageCounter++}`;
                const pageName = `新しいページ ${pageCounter - 3}`;
                addPage(pageId, pageName);
            });

            function addPage(pageId, pageName) {
                const pageItem = document.createElement('div');
                pageItem.className = 'page-item flex w-full items-center justify-between rounded-lg px-3 py-2 text-slate-600 hover:bg-slate-100 cursor-move';
                pageItem.dataset.pageId = pageId;
                pageItem.draggable = true;
                pageItem.innerHTML = `
                    <span>${pageName}</span>
                    <div class="flex items-center space-x-1">
                        <button class="page-delete rounded p-1 text-slate-400 hover:text-red-600 hover:bg-red-50">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                            </svg>
                        </button>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4 text-slate-400">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </div>
                `;
                
                // イベントリスナーを追加
                setupPageItemEvents(pageItem);
                
                // ページリストに追加
                pageList.appendChild(pageItem);
                
                // 新規追加されたページを選択
                selectPage(pageId);
            }

            // ページ選択機能
            function selectPage(pageId) {
                selectedPageId = pageId;
                document.querySelectorAll('.page-item').forEach(item => {
                    if (item.dataset.pageId === pageId) {
                        item.classList.add('bg-blue-50', 'text-blue-700', 'shadow-sm');
                        item.classList.remove('text-slate-600');
                    } else {
                        item.classList.remove('bg-blue-50', 'text-blue-700', 'shadow-sm');
                        item.classList.add('text-slate-600');
                    }
                });
            }

            // ページアイテムのイベント設定
            function setupPageItemEvents(pageItem) {
                // クリックで選択
                pageItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.page-delete')) {
                        selectPage(pageItem.dataset.pageId);
                    }
                });

                // 削除ボタン
                const deleteBtn = pageItem.querySelector('.page-delete');
                deleteBtn?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('このページを削除しますか？')) {
                        pageItem.remove();
                        // 最初のページを選択
                        const firstPage = pageList.querySelector('.page-item');
                        if (firstPage) {
                            selectPage(firstPage.dataset.pageId);
                        }
                    }
                });

                // ドラッグ&ドロップ
                pageItem.addEventListener('dragstart', (e) => {
                    draggedElement = pageItem;
                    pageItem.style.opacity = '0.5';
                });

                pageItem.addEventListener('dragend', () => {
                    pageItem.style.opacity = '1';
                    draggedElement = null;
                });

                pageItem.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== pageItem) {
                        const rect = pageItem.getBoundingClientRect();
                        const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                        pageList.insertBefore(draggedElement, next ? pageItem.nextSibling : pageItem);
                    }
                });

                pageItem.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== pageItem) {
                        pageItem.classList.add('ring-2', 'ring-blue-500');
                    }
                });

                pageItem.addEventListener('dragleave', () => {
                    pageItem.classList.remove('ring-2', 'ring-blue-500');
                });

                pageItem.addEventListener('drop', (e) => {
                    e.preventDefault();
                    pageItem.classList.remove('ring-2', 'ring-blue-500');
                });
            }

            // 既存のページアイテムにイベントを設定
            document.querySelectorAll('.page-item').forEach(item => {
                setupPageItemEvents(item);
            });

            // 設定画面の表示切り替え
            function showSettingsContent(contentType) {
                // すべての設定コンテンツを非表示
                document.querySelectorAll('.settings-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // すべての設定サイドバーボタンのスタイルをリセット
                document.querySelectorAll('.settings-sidebar-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-50', 'text-blue-700', 'shadow-sm');
                    btn.classList.add('text-slate-600');
                });
                
                // 選択された設定コンテンツを表示
                const content = document.getElementById(`settings-${contentType}`);
                if (content) {
                    content.classList.remove('hidden');
                }
                
                // 選択されたサイドバーボタンをハイライト
                const btn = document.getElementById(`settings-btn-${contentType}`);
                if (btn) {
                    btn.classList.add('bg-blue-50', 'text-blue-700', 'shadow-sm');
                    btn.classList.remove('text-slate-600');
                }
            }

            // 設定サイドバーボタンのイベントリスナー
            document.querySelectorAll('.settings-sidebar-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const contentType = btn.dataset.settings;
                    showSettingsContent(contentType);
                });
            });

            // 設定画面の保存機能
            const settingsSaveBtn = document.getElementById('settings-save-btn');
            settingsSaveBtn?.addEventListener('click', async () => {
                if (!appId) {
                    alert('アプリが読み込まれていません');
                    return;
                }

                const appNameInput = document.getElementById('settings-app-name');
                const appDescriptionInput = document.getElementById('settings-app-description');

                if (!appNameInput) {
                    alert('設定画面が読み込まれていません');
                    return;
                }

                const appName = appNameInput.value.trim();
                const appDescription = appDescriptionInput?.value.trim() || '';

                if (!appName) {
                    alert('アプリ名を入力してください');
                    appNameInput.focus();
                    return;
                }

                // ローディング表示
                const originalText = settingsSaveBtn.textContent;
                settingsSaveBtn.disabled = true;
                settingsSaveBtn.textContent = '保存中...';

                try {
                    // データベースサービスが初期化されるまで待つ
                    await databaseService.init();
                    
                    // Firebase/Firestoreでアプリを更新
                    const updatedApp = await databaseService.updateApp(appId, {
                        name: appName,
                        description: appDescription
                    });

                    if (updatedApp) {
                        // 現在のアプリ情報も更新
                        if (currentApp) {
                            currentApp.name = appName;
                            currentApp.description = appDescription;
                        }
                        
                        // ヘッダータイトルも更新
                        if (viewTitle) {
                            viewTitle.textContent = appName;
                        }
                        // ブラウザタブのタイトルも更新
                        document.title = appName + ' - AppNavi';
                        
                        // 通知表示
                        showNotification('設定を保存しました');
                    } else {
                        alert('アプリの更新に失敗しました');
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                    // フォールバック: localStorageで更新
                    const savedApps = localStorage.getItem('apps');
                    if (savedApps) {
                        const apps = JSON.parse(savedApps);
                        const appIndex = apps.findIndex(app => app.id === appId);
                        if (appIndex !== -1) {
                            apps[appIndex].name = appName;
                            apps[appIndex].description = appDescription;
                            apps[appIndex].updatedAt = new Date().toISOString();
                            localStorage.setItem('apps', JSON.stringify(apps));
                            
                            if (viewTitle) {
                                viewTitle.textContent = appName;
                            }
                            // ブラウザタブのタイトルも更新
                            document.title = appName + ' - AppNavi';
                            
                            showNotification('設定を保存しました（ローカル保存）');
                        } else {
                            alert('アプリが見つかりませんでした');
                        }
                    } else {
                        alert('アプリデータが見つかりませんでした');
                    }
                } finally {
                    settingsSaveBtn.disabled = false;
                    settingsSaveBtn.textContent = originalText;
                }
            });

            // アプリ読み込み時に設定画面の値を設定
            function updateSettingsForm() {
                if (currentApp) {
                    const appNameInput = document.getElementById('settings-app-name');
                    const appDescriptionInput = document.getElementById('settings-app-description');
                    if (appNameInput) appNameInput.value = currentApp.name || '';
                    if (appDescriptionInput) appDescriptionInput.value = currentApp.description || '';
                }
            }

            // アプリ読み込み後に設定フォームを更新
            if (currentApp) {
                updateSettingsForm();
            }

            // 設定タブが選択されたときにフォームを更新するため、setTab関数を拡張
            const originalSetTabFunction = setTab;
            window.setTab = function(tabName) {
                originalSetTabFunction(tabName);
                if (tabName === 'settings') {
                    updateSettingsForm();
                }
            };

            // Google Sheets API連携機能
            const settingsSheetUrlInput = document.getElementById('settings-sheet-url');
            const settingsApiConnectBtn = document.querySelector('#settings-api button:last-child');
            
            settingsApiConnectBtn?.addEventListener('click', async () => {
                const sheetUrl = settingsSheetUrlInput?.value.trim();
                
                if (!sheetUrl) {
                    alert('スプレッドシートURLを入力してください');
                    return;
                }

                // URLの検証
                if (!sheetUrl.includes('docs.google.com/spreadsheets')) {
                    alert('有効なGoogleスプレッドシートのURLを入力してください');
                    return;
                }

                // ローディング表示
                const originalText = settingsApiConnectBtn.textContent;
                settingsApiConnectBtn.disabled = true;
                settingsApiConnectBtn.textContent = '接続中...';

                try {
                    // Google Sheets APIサービスの初期化
                    await googleSheetsService.initAuth();
                    
                    // 認証が必要な場合
                    if (!googleSheetsService.isAuthenticated) {
                        const shouldSignIn = confirm('Google認証が必要です。認証を開始しますか？');
                        if (shouldSignIn) {
                            await googleSheetsService.signIn();
                        } else {
                            throw new Error('認証が必要です');
                        }
                    }

                    // スプレッドシートのデータを取得・分析
                    showNotification('スプレッドシートを分析中...', 'info');
                    const analysis = await googleSheetsService.analyzeSpreadsheet(sheetUrl);

                    if (!analysis.headers || analysis.headers.length === 0) {
                        throw new Error('スプレッドシートにデータが見つかりませんでした');
                    }

                    // アプリデータを更新（スプレッドシート連携情報を追加）
                    if (appId && databaseService) {
                        await databaseService.updateApp(appId, {
                            googleSheetsUrl: sheetUrl,
                            googleSheetsLastSynced: new Date().toISOString()
                        });

                        // データを同期
                        if (analysis.rows && analysis.rows.length > 0) {
                            // 列設定を更新（もしデータ型が検出された場合）
                            const columns = analysis.headers.map(header => {
                                const dataType = analysis.dataTypes[header] || { type: 'text' };
                                return {
                                    name: header,
                                    type: dataType.type,
                                    required: false,
                                    options: dataType.options || null
                                };
                            });

                            // アプリデータを更新
                            await databaseService.updateApp(appId, {
                                columns: columns,
                                data: analysis.rows,
                                googleSheetsLastSynced: new Date().toISOString()
                            });

                            // 現在のアプリ情報も更新
                            if (currentApp) {
                                currentApp.columns = columns;
                                currentApp.data = analysis.rows;
                                currentApp.googleSheetsUrl = sheetUrl;
                            }

                            // データテーブルを更新
                            if (analysis.rows && analysis.rows.length > 0 && columns) {
                                updateAppDataTable(analysis.rows, columns);
                            }

                            showNotification('Googleスプレッドシートと連携しました');
                        }
                    } else {
                        showNotification('スプレッドシートを分析しましたが、アプリが見つかりませんでした', 'warning');
                    }
                } catch (error) {
                    console.error('Error connecting to Google Sheets:', error);
                    alert(`Googleスプレッドシートとの連携に失敗しました。\n\nエラー: ${error.message}\n\n注意: Google API Client Libraryが必要です。`);
                    showNotification('連携に失敗しました', 'error');
                } finally {
                    settingsApiConnectBtn.disabled = false;
                    settingsApiConnectBtn.textContent = originalText;
                }
            });

            // 検索機能の実装
            const searchInput = document.querySelector('#search-bar input[type="search"]');
            let filteredData = null;
            
            searchInput?.addEventListener('input', (e) => {
                const searchTerm = e.target.value.trim().toLowerCase();
                if (!searchTerm) {
                    // 検索が空の場合は元のデータを表示
                    if (currentApp && currentApp.data && currentApp.columns) {
                        updateAppDataTable(currentApp.data, currentApp.columns);
                    } else if (selectedTable) {
                        updateTableDisplay(selectedTable);
                    }
                    filteredData = null;
                    return;
                }
                
                // データをフィルタリング
                if (currentApp && currentApp.data && currentApp.columns) {
                    filteredData = currentApp.data.filter(row => {
                        return currentApp.columns.some(col => {
                            const value = String(row[col.name] || '').toLowerCase();
                            return value.includes(searchTerm);
                        });
                    });
                    updateAppDataTable(filteredData, currentApp.columns);
                } else if (selectedTable && tableData[selectedTable]) {
                    // サンプルデータの場合
                    const data = tableData[selectedTable];
                    const filteredRows = data.rows.filter(row => {
                        return row.some(cell => String(cell).toLowerCase().includes(searchTerm));
                    });
                    
                    // フィルタリングされたテーブルを表示
                    const tableBody = document.getElementById('table-body');
                    if (tableBody) {
                        tableBody.innerHTML = filteredRows.map(row => {
                            const firstCell = row[0];
                            const isLink = firstCell.startsWith('R-') || firstCell.startsWith('E-') || firstCell.startsWith('U-');
                            const firstCellHTML = isLink ? `<td class="px-6 py-4 font-semibold text-blue-600">${firstCell}</td>` : `<td class="px-6 py-4 font-semibold text-blue-600">${firstCell}</td>`;
                            
                            return `<tr class="hover:bg-slate-50">
                                ${firstCellHTML}
                                ${row.slice(1).map(cell => `<td class="px-6 py-4">${cell}</td>`).join('')}
                                ${getActionButtonsHTML(row[0])}
                            </tr>`;
                        }).join('');
                        
                        if (filteredRows.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="' + data.headers.length + '" class="px-6 py-8 text-center text-slate-500">検索結果が見つかりませんでした</td></tr>';
                        }
                    }
                }
            });

            // アクションボタンのHTML生成（編集・削除）
            function getActionButtonsHTML(rowId) {
                return `<td class="px-6 py-4">
                    <div class="flex items-center space-x-2">
                        <button class="edit-row-btn rounded-lg p-1.5 text-blue-600 hover:bg-blue-50" data-row-id="${rowId}" title="編集">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                            </svg>
                        </button>
                        <button class="delete-row-btn rounded-lg p-1.5 text-red-600 hover:bg-red-50" data-row-id="${rowId}" title="削除">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                            </svg>
                        </button>
                    </div>
                </td>`;
            }

            // データテーブルの更新関数を拡張（編集・削除ボタンを追加）
            const originalUpdateAppDataTable = updateAppDataTable;
            updateAppDataTable = function(data, columns) {
                originalUpdateAppDataTable(data, columns);
                
                // アクションボタン列を追加
                const tableHead = document.getElementById('table-head');
                const tableBody = document.getElementById('table-body');
                
                if (tableHead) {
                    const headerRow = tableHead.querySelector('tr');
                    if (headerRow && !headerRow.querySelector('th:last-child')?.textContent.includes('操作')) {
                        headerRow.innerHTML += '<th class="px-6 py-3 text-left font-semibold">操作</th>';
                    }
                }
                
                if (tableBody) {
                    // 各行にアクションボタンを追加
                    const rows = tableBody.querySelectorAll('tr');
                    rows.forEach((row, index) => {
                        if (!row.querySelector('.edit-row-btn')) {
                            const rowId = `row-${index}`;
                            row.innerHTML += getActionButtonsHTML(rowId);
                            
                            // イベントリスナーを追加
                            const editBtn = row.querySelector('.edit-row-btn');
                            const deleteBtn = row.querySelector('.delete-row-btn');
                            
                            editBtn?.addEventListener('click', () => {
                                editDataRow(index, data[index], columns);
                            });
                            
                            deleteBtn?.addEventListener('click', () => {
                                deleteDataRow(index, data[index]);
                            });
                        }
                    });
                }
            };

            // データ編集機能（より使いやすいモーダル版）
            function editDataRow(index, rowData, columns) {
                if (!currentApp || !currentApp.data || !currentApp.columns) {
                    showNotification('データを編集できません。アプリデータが読み込まれていません。', 'error');
                    return;
                }
                
                // 編集フォームを表示（手動入力フォームと同じUIを使用）
                const formColumns = currentApp.columns;
                const originalData = { ...rowData };
                
                // モーダルのコンテンツを編集フォームに変更
                const modalContent = document.querySelector('#data-add-modal .px-6');
                if (!modalContent) return;
                
                let formHTML = '<div class="space-y-4">';
                columns.forEach(col => {
                    const required = col.required ? '<span class="text-red-500">*</span>' : '';
                    const currentValue = originalData[col.name] || '';
                    let inputHTML = '';
                    
                    switch (col.type) {
                        case 'select':
                            const options = col.options || [];
                            inputHTML = `
                                <select id="edit-field-${col.name}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" ${col.required ? 'required' : ''}>
                                    <option value="">選択してください</option>
                                    ${options.map(opt => `<option value="${opt}" ${opt === currentValue ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            `;
                            break;
                        case 'date':
                            inputHTML = `<input type="date" id="edit-field-${col.name}" value="${currentValue}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" ${col.required ? 'required' : ''} />`;
                            break;
                        case 'datetime':
                            inputHTML = `<input type="datetime-local" id="edit-field-${col.name}" value="${currentValue}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" ${col.required ? 'required' : ''} />`;
                            break;
                        case 'number':
                            inputHTML = `<input type="number" id="edit-field-${col.name}" value="${currentValue}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" ${col.required ? 'required' : ''} />`;
                            break;
                        default:
                            inputHTML = `<input type="text" id="edit-field-${col.name}" value="${currentValue}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="${col.name}を入力" ${col.required ? 'required' : ''} />`;
                    }
                    
                    formHTML += `
                        <div>
                            <label class="text-sm font-semibold text-slate-700 mb-1 block">${col.name} ${required}</label>
                            ${inputHTML}
                        </div>
                    `;
                });
                
                formHTML += '</div>';
                formHTML += `
                    <div class="mt-6 flex items-center justify-end space-x-2">
                        <button id="data-edit-form-cancel" class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">キャンセル</button>
                        <button id="data-edit-form-save" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-700">保存</button>
                    </div>
                `;
                
                modalContent.innerHTML = `
                    <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4 -mx-6 -mt-6 mb-6">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-900">データを編集</h3>
                            <p class="text-xs text-slate-500">データの内容を変更できます。保存ボタンをクリックすると変更が反映されます。</p>
                        </div>
                        <button id="data-add-modal-close" class="rounded-full border border-slate-200 p-2 text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    ${formHTML}
                `;
                
                // モーダルを表示
                const modal = document.getElementById('data-add-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
                
                // イベントリスナーを追加
                document.getElementById('data-edit-form-save')?.addEventListener('click', () => {
                    saveEditedDataRow(index, formColumns);
                });
                document.getElementById('data-edit-form-cancel')?.addEventListener('click', () => {
                    closeDataAddModal();
                    // モーダルを元に戻す
                    setTimeout(() => {
                        location.reload();
                    }, 300);
                });
            }
            
            // 編集したデータ行を保存
            async function saveEditedDataRow(index, columns) {
                if (!currentApp || !currentApp.data) {
                    showNotification('データを更新できません。アプリデータが読み込まれていません。', 'error');
                    return;
                }
                
                const newRowData = {};
                let hasError = false;
                
                columns.forEach(col => {
                    const input = document.getElementById(`edit-field-${col.name}`);
                    if (!input) {
                        hasError = true;
                        return;
                    }
                    
                    const value = input.value.trim();
                    if (col.required && !value) {
                        showNotification(`${col.name}は必須項目です。入力してください。`, 'error');
                        input.focus();
                        hasError = true;
                        return;
                    }
                    
                    newRowData[col.name] = value;
                });
                
                if (hasError) return;
                
                // データを更新
                currentApp.data[index] = { ...currentApp.data[index], ...newRowData };
                
                // データベースに保存
                if (appId && databaseService) {
                    try {
                        await databaseService.updateApp(appId, {
                            data: currentApp.data
                        });
                        updateAppDataTable(currentApp.data, currentApp.columns);
                        closeDataAddModal();
                        showNotification('データを更新しました');
                    } catch (error) {
                        console.error('Error updating data:', error);
                        showNotification('データの更新に失敗しました。もう一度お試しください。', 'error');
                    }
                } else {
                    updateAppDataTable(currentApp.data, currentApp.columns);
                    closeDataAddModal();
                    showNotification('データを更新しました（ローカル保存）');
                }
            }

            // データ削除機能（より分かりやすい確認）
            async function deleteDataRow(index, rowData) {
                // より分かりやすい確認メッセージ
                const confirmMessage = `このデータを削除しますか？\n\nこの操作は元に戻せません。\n削除を続ける場合は「OK」をクリックしてください。`;
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                if (currentApp && currentApp.data) {
                    currentApp.data.splice(index, 1);
                    
                    // データベースに保存
                    if (appId && databaseService) {
                        try {
                            await databaseService.updateApp(appId, {
                                data: currentApp.data
                            });
                            updateAppDataTable(currentApp.data, currentApp.columns);
                            showNotification('データを削除しました');
                        } catch (error) {
                            console.error('Error deleting data:', error);
                            showNotification('データの削除に失敗しました', 'error');
                        }
                    } else {
                        updateAppDataTable(currentApp.data, currentApp.columns);
                        showNotification('データを削除しました（ローカル保存）');
                    }
                }
            }

            // データ追加モーダルの「手動で入力」ボタンの実装
            const dataAddModalContent = document.querySelector('#data-add-modal .space-y-4');
            const manualInputBtn = dataAddModalContent?.querySelector('button:first-child');
            const excelImportBtn = dataAddModalContent?.querySelector('button:nth-child(2)');
            const csvImportBtn = dataAddModalContent?.querySelector('button:nth-child(3)');
            
            manualInputBtn?.addEventListener('click', () => {
                if (!selectedTable && (!currentApp || !currentApp.columns)) {
                    showNotification('データテーブルを選択してください。左側のサイドバーからテーブルを選択してから、もう一度お試しください。', 'error');
                    return;
                }
                
                // フォームを表示
                showManualInputForm();
            });

            // 手動入力フォーム表示
            function showManualInputForm() {
                const columns = currentApp?.columns || [];
                if (columns.length === 0) {
                    showNotification('データ構造が定義されていません。先にExcelファイルをアップロードしてアプリを作成してください。', 'error');
                    closeDataAddModal();
                    return;
                }
                
                // モーダルのコンテンツを置き換え
                const modalContent = document.querySelector('#data-add-modal .px-6');
                if (!modalContent) return;
                
                let formHTML = '<div class="space-y-4">';
                columns.forEach(col => {
                    const required = col.required ? '<span class="text-red-500">*</span>' : '';
                    let inputHTML = '';
                    
                    switch (col.type) {
                        case 'select':
                            const options = col.options || [];
                            inputHTML = `
                                <select id="add-field-${col.name}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" ${col.required ? 'required' : ''}>
                                    <option value="">選択してください</option>
                                    ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                </select>
                            `;
                            break;
                        case 'date':
                            inputHTML = `<input type="date" id="add-field-${col.name}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" ${col.required ? 'required' : ''} />`;
                            break;
                        case 'datetime':
                            inputHTML = `<input type="datetime-local" id="add-field-${col.name}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" ${col.required ? 'required' : ''} />`;
                            break;
                        case 'number':
                            inputHTML = `<input type="number" id="add-field-${col.name}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" ${col.required ? 'required' : ''} />`;
                            break;
                        default:
                            inputHTML = `<input type="text" id="add-field-${col.name}" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="${col.name}を入力" ${col.required ? 'required' : ''} />`;
                    }
                    
                    formHTML += `
                        <div>
                            <label class="text-sm font-semibold text-slate-700 mb-1 block">${col.name} ${required}</label>
                            ${inputHTML}
                        </div>
                    `;
                });
                
                formHTML += '</div>';
                formHTML += `
                    <div class="mt-6 flex items-center justify-end space-x-2">
                        <button id="data-add-form-cancel" class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100">キャンセル</button>
                        <button id="data-add-form-save" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-700">保存</button>
                    </div>
                `;
                
                modalContent.innerHTML = `
                    <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4 -mx-6 -mt-6 mb-6">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-900">データを追加</h3>
                            <p class="text-xs text-slate-500" id="modal-table-name">新しいデータを入力してください。</p>
                        </div>
                        <button id="data-add-modal-close" class="rounded-full border border-slate-200 p-2 text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    ${formHTML}
                `;
                
                // イベントリスナーを追加
                document.getElementById('data-add-form-save')?.addEventListener('click', saveNewDataRow);
                document.getElementById('data-add-form-cancel')?.addEventListener('click', () => {
                    closeDataAddModal();
                    // モーダルを元に戻す
                    location.reload();
                });
            }

            // 新しいデータ行を保存
            async function saveNewDataRow() {
                if (!currentApp || !currentApp.columns) {
                    showNotification('データ構造が定義されていません。先にExcelファイルをアップロードしてアプリを作成してください。', 'error');
                    return;
                }
                
                const newRow = {};
                let hasError = false;
                
                currentApp.columns.forEach(col => {
                    const input = document.getElementById(`add-field-${col.name}`);
                    if (!input) {
                        hasError = true;
                        return;
                    }
                    
                    const value = input.value.trim();
                    if (col.required && !value) {
                        showNotification(`${col.name}は必須項目です。入力してください。`, 'error');
                        input.focus();
                        hasError = true;
                        return;
                    }
                    
                    newRow[col.name] = value;
                });
                
                if (hasError) return;
                
                // データを追加
                if (!currentApp.data) {
                    currentApp.data = [];
                }
                currentApp.data.push(newRow);
                
                // データベースに保存
                if (appId && databaseService) {
                    try {
                        await databaseService.updateApp(appId, {
                            data: currentApp.data
                        });
                        updateAppDataTable(currentApp.data, currentApp.columns);
                        closeDataAddModal();
                        showNotification('データを追加しました');
                    } catch (error) {
                        console.error('Error adding data:', error);
                        showNotification('データの追加に失敗しました', 'error');
                    }
                } else {
                    updateAppDataTable(currentApp.data, currentApp.columns);
                    closeDataAddModal();
                    showNotification('データを追加しました（ローカル保存）');
                }
            }

            // エクスポート機能を追加（テーブルヘッダーにエクスポートボタンを追加）
            function addExportButton() {
                const tableHeader = document.querySelector('#data-view .flex.items-center.justify-between');
                if (tableHeader && !tableHeader.querySelector('#export-btn')) {
                    const exportBtn = document.createElement('button');
                    exportBtn.id = 'export-btn';
                    exportBtn.className = 'inline-flex items-center rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 shadow-sm hover:bg-slate-50';
                    exportBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mr-2 h-4 w-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        エクスポート
                    `;
                    exportBtn.addEventListener('click', exportData);
                    tableHeader.appendChild(exportBtn);
                }
            }

            // データエクスポート機能
            function exportData() {
                const data = filteredData || currentApp?.data || [];
                const columns = currentApp?.columns || [];
                
                if (data.length === 0) {
                    showNotification('エクスポートするデータがありません。先にデータを追加してください。', 'warning');
                    return;
                }
                
                showNotification('データをエクスポート中...', 'info');
                
                // CSV形式でエクスポート
                const headers = columns.map(col => col.name);
                const csvRows = [headers.join(',')];
                
                data.forEach(row => {
                    const values = headers.map(header => {
                        const value = row[header] || '';
                        // カンマやダブルクォートが含まれる場合はエスケープ
                        if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                            return `"${String(value).replace(/"/g, '""')}"`;
                        }
                        return value;
                    });
                    csvRows.push(values.join(','));
                });
                
                const csvContent = csvRows.join('\n');
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `${currentApp?.name || 'データ'}_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('データをエクスポートしました');
            }

            // 通知表示関数を改善
            const originalShowNotification = showNotification;
            showNotification = function(message, type = 'success') {
                // 既存の通知を削除
                const existingNotification = document.querySelector('.notification-toast');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const bgColors = {
                    success: 'bg-blue-600',
                    error: 'bg-red-600',
                    warning: 'bg-amber-600',
                    info: 'bg-slate-600'
                };

                const notification = document.createElement('div');
                notification.className = `notification-toast fixed top-4 right-4 z-50 rounded-lg ${bgColors[type] || bgColors.success} px-4 py-3 text-sm text-white shadow-lg`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            };

            // エクスポートボタンを追加
            setTimeout(() => {
                addExportButton();
            }, 1000);

            // デフォルトで「データ」タブを選択
            setTab('data');
        });
    </script>
</body>
</html>

